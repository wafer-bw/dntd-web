(()=>{"use strict";var e={5405:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class o extends Error{constructor(e,t){super(e),this.msg=e,this.friendlyMsg=t}}t.FriendlyError=o},2877:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=o(1230);class r extends Error{constructor(e,t,o,r,n){super(e),this.friendlyMsg=t,this.needsReAuth=o,this.payload={pause:void 0===r||r,error:this,friendlyMsg:this.friendlyMsg,type:s.SyncerPayloadType.ERROR,rejects:void 0!==n&&n}}}t.SyncerError=r},8037:(e,t,o)=>{function s(e){for(var o in e)t.hasOwnProperty(o)||(t[o]=e[o])}Object.defineProperty(t,"__esModule",{value:!0}),s(o(2877)),s(o(5405))},1230:(e,t,o)=>{function s(e){for(var o in e)t.hasOwnProperty(o)||(t[o]=e[o])}Object.defineProperty(t,"__esModule",{value:!0}),s(o(1298)),s(o(5579)),s(o(7013))},1298:(e,t)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),(o=t.SearchType||(t.SearchType={}))[o.NONE=0]="NONE",o[o.AND=1]="AND",o[o.OR=2]="OR"},7013:(e,t)=>{var o,s,r;Object.defineProperty(t,"__esModule",{value:!0}),(r=t.SyncerPayloadType||(t.SyncerPayloadType={}))[r.AUTH_UPDATE=0]="AUTH_UPDATE",r[r.DELETE_ROW=1]="DELETE_ROW",r[r.UPDATE_ROW=2]="UPDATE_ROW",r[r.GET_ROWS=3]="GET_ROWS",r[r.TEST_MODE_UPDATE=4]="TEST_MODE_UPDATE",r[r.UNPAUSE=5]="UNPAUSE",r[r.GET_SPREADSHEET=6]="GET_SPREADSHEET",r[r.EXTEND_SHEET=7]="EXTEND_SHEET",r[r.CREATE_ROW=8]="CREATE_ROW",r[r.MOVE_ROW=9]="MOVE_ROW",r[r.ERROR=10]="ERROR",r[r.TOKEN_REQUEST=11]="TOKEN_REQUEST",r[r.SYNC_STATE=12]="SYNC_STATE",(s=t.SyncerResponseType||(t.SyncerResponseType={}))[s.SYNCER_STATE=0]="SYNCER_STATE",s[s.ERROR=1]="ERROR",s[s.REAUTH=2]="REAUTH",(o=t.SyncerState||(t.SyncerState={})).PAUSED="cloud_off",o.UPLOADING="cloud_upload",o.DOWNLOADING="cloud_download",o.SYNCED="cloud_done",o.INITIALIZING="cloud_queue"},5579:(e,t)=>{var o;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.OFF="0",e.WORKING="1",e.FAIL_GET_SPREADSHEET_SHEETS="2",e.FAIL_GET_RANGE="3",e.FAIL_UPDATE_RANGE="4",e.FAIL_DELETE_ROW="5",e.RETURN_ROWS="6",e.DEMO="demomode"}(o=t.TestMode||(t.TestMode={})),t.instanceOfTestMode=function(e){return Object.values(o).includes(e)}},3118:(e,t,o)=>{function s(e){for(var o in e)t.hasOwnProperty(o)||(t[o]=e[o])}Object.defineProperty(t,"__esModule",{value:!0}),s(o(2197)),s(o(3341))},8651:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=o(1230);function r(e){postMessage({payload:e})}t.postSyncStateMessage=function(e,t){r({length:e,state:t,type:s.SyncerPayloadType.SYNC_STATE,rejects:!1})},t.postTokenRequestMessage=function(){r({type:s.SyncerPayloadType.TOKEN_REQUEST,rejects:!1})}},3341:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(3118),n=o(8037),a=o(7155),i=o(8651),d=o(1230);t.syncRate=250;const c=new a.TaskFactory,u=new Map,l=[];let h,y=0,p=d.TestMode.OFF,f=d.SyncerState.SYNCED;function E(e){void 0!==e&&f!==e&&(f=e,i.postSyncStateMessage(l.length,f))}function T(e,t){let o=r.instanceOfSyncerError(e)?e:new n.SyncerError(e.message,"Unknown Error",!1);if(o.needsReAuth)return i.postTokenRequestMessage(),void(h=void 0);o.payload.pause&&E(d.SyncerState.PAUSED),postMessage({id:t,error:o.payload})}function S(){return s(this,void 0,void 0,(function*(){for(;0!==l.length&&h&&f!==d.SyncerState.PAUSED;){E(d.SyncerState.UPLOADING);let{id:e,task:t}=l[0];try{let o=yield t.work(h);postMessage({id:e,payload:o}),l.shift()}catch(t){T(t,e)}}}))}function w(){if(0!==u.size&&h&&f!==d.SyncerState.PAUSED){E(d.SyncerState.DOWNLOADING);for(let[e,t]of u.entries())y+=1,u.delete(e),t.work(h).then((t=>postMessage({id:e,payload:t}))).catch((t=>T(t,e))).finally((()=>y-=1))}}function _(e){return new Promise((t=>setTimeout(t,e)))}!function(){s(this,void 0,void 0,(function*(){for(;;)yield _(t.syncRate),f!==d.SyncerState.PAUSED&&f!==d.SyncerState.SYNCED&&l.length+u.size+y===0&&E(d.SyncerState.SYNCED),w(),yield S()}))}(),onmessage=e=>function(e){const{id:t,payload:o}=e.data;switch(o.type){case d.SyncerPayloadType.TEST_MODE_UPDATE:return p=o.testMode,void(p!==d.TestMode.OFF&&(h="mock"));case d.SyncerPayloadType.AUTH_UPDATE:return void(h=o.token);case d.SyncerPayloadType.UNPAUSE:return void E(d.SyncerState.UPLOADING)}let s=c.createTask(o,p);void 0!==s&&(s.async?u.set(t,s):l.push({id:t,task:s}))}(e)},9703:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=o(1230),r=o(7155);t.TaskFactory=class{createTask(e,t){switch(e.type){case s.SyncerPayloadType.CREATE_ROW:return r.createCreateRowTask(e,t);case s.SyncerPayloadType.GET_ROWS:return r.createGetRowsTask(e,t);case s.SyncerPayloadType.GET_SPREADSHEET:return r.createGetSpreadsheetTask(e,t);case s.SyncerPayloadType.UPDATE_ROW:return r.createUpdateRowTask(e,t);case s.SyncerPayloadType.DELETE_ROW:return r.createDeleteRowTask(e,t);default:return void console.warn("Task factory told to build unsupported task")}}},t.BaseTask=class{constructor(e,t){this.testMode=s.TestMode.OFF,this.payload=e,this.testMode=void 0!==t?t:this.testMode}}},6680:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(9703),n=o(1230),a=o(8037);t.createCreateRowTask=function(e,t){return t===n.TestMode.OFF?new i(e):new d(e,t)};class i extends r.BaseTask{constructor(e){super(e)}work(e){return s(this,void 0,void 0,(function*(){let t={sheetId:this.payload.sheetId,startIndex:this.payload.idx,endIndex:this.payload.idx+1,dimension:"ROWS"},o=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${this.payload.spreadsheetId}:batchUpdate`),s={method:"POST",cache:"no-cache",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({requests:[{insertDimension:{range:t}}]})},r=yield fetch(o.toString(),s);if(!r.ok){let e=yield r.json();throw new a.SyncerError(JSON.stringify(e),"Failed to create new entry",401===r.status)}return this.payload}))}}t.CreateRowTask=i;class d extends r.BaseTask{constructor(e,t){super(e,t)}work(e){return s(this,void 0,void 0,(function*(){if(this.testMode===n.TestMode.FAIL_DELETE_ROW){let e=new Error("mock fail");throw new a.SyncerError(JSON.stringify(e),"Failed to create new entry",!1)}return this.payload}))}}t.MockCreateRowTask=d},3494:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(9703),n=o(1230),a=o(8037);t.createDeleteRowTask=function(e,t){return t===n.TestMode.OFF?new i(e):new d(e,t)};class i extends r.BaseTask{constructor(e){super(e)}work(e){return s(this,void 0,void 0,(function*(){let t={sheetId:this.payload.sheetId,startRowIndex:this.payload.idx,endRowIndex:this.payload.idx+1,startColumnIndex:0},o=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${this.payload.spreadsheetId}:batchUpdate`),s={method:"POST",cache:"no-cache",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({requests:[{deleteRange:{range:t,shiftDimension:"ROWS"}}]})},r=yield fetch(o.toString(),s);if(!r.ok){let e=yield r.json();throw new a.SyncerError(JSON.stringify(e),"Failed to delete entry",401===r.status)}return this.payload}))}}t.DeleteRowTask=i;class d extends r.BaseTask{constructor(e,t){super(e,t)}work(e){return s(this,void 0,void 0,(function*(){if(this.testMode===n.TestMode.FAIL_DELETE_ROW){let e=new Error("mock fail");throw new a.SyncerError(JSON.stringify(e),"Failed to delete entry",!1)}return this.payload}))}}t.MockDeleteRowTask=d},9337:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(9703),n=o(8037);class a extends r.BaseTask{constructor(e){super(e)}work(e){return s(this,void 0,void 0,(function*(){let t=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${this.payload.spreadsheetId}:batchUpdate`),o={method:"POST",mode:"cors",cache:"no-cache",headers:{Authorization:`Bearer ${e}`},body:JSON.stringify({requests:[{appendDimension:{sheetId:this.payload.sheetId,dimension:"ROWS",length:100}}]})},s=yield fetch(t.toString(),o);if(!s.ok){let e=yield s.json();throw new n.SyncerError(JSON.stringify(e),"Failed to extend Google Sheet",401===s.status)}return this.payload}))}}t.ExtendSheetTask=a},7094:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(9703),n=o(1230),a=o(8037);t.createGetRowsTask=function(e,t){return t===n.TestMode.OFF?new i(e):new d(e,t)};class i extends r.BaseTask{constructor(e){super(e),this.async=!0}work(e){return s(this,void 0,void 0,(function*(){let t=`${this.payload.sheetTitle}!A:A`,o=`https://sheets.googleapis.com/v4/spreadsheets/${this.payload.spreadsheetId}/values/${t}`,s={method:"GET",cache:"no-cache",headers:{Authorization:`Bearer ${e}`}},r=yield fetch(o,s);if(!r.ok){let e=yield r.json();throw new a.SyncerError(JSON.stringify(e),`Failed to load entries from ${this.payload.spreadsheetId}`,401===r.status,!0,!0)}{let e=yield r.json();this.payload.rows=e.values?e.values.map((e=>e[0])):[]}return this.payload}))}}t.GetRowsTask=i;class d extends r.BaseTask{constructor(e,t){super(e,t),this.async=!0}work(e){return s(this,void 0,void 0,(function*(){if(this.testMode===n.TestMode.FAIL_GET_RANGE){let e=new Error("mock fail");throw new a.SyncerError(JSON.stringify(e),`Failed to load entries from ${this.payload.spreadsheetId}`,!1,!0,!0)}return this.testMode===n.TestMode.RETURN_ROWS&&(this.payload.rows=["aaa","bbb","ccc","@tag","@key:value"]),this.payload}))}}t.MockGetRowsTask=d},9636:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(9703),n=o(1230),a=o(8037);t.createGetSpreadsheetTask=function(e,t){return t===n.TestMode.OFF?new i(e):new d(e,t)};class i extends r.BaseTask{constructor(e){super(e),this.async=!0}work(e){return s(this,void 0,void 0,(function*(){let t=`https://sheets.googleapis.com/v4/spreadsheets/${this.payload.spreadsheetId}`,o={method:"GET",cache:"no-cache",headers:{Authorization:`Bearer ${e}`}},s=yield fetch(t,o);if(!s.ok){let e=yield s.json();throw new a.SyncerError(JSON.stringify(e),`Could not get spreadsheet information for ${this.payload.spreadsheetId}`,401===s.status,!1,!0)}return this.payload.spreadsheet=yield s.json(),this.payload}))}}t.GetSpreadsheetTask=i;class d extends r.BaseTask{constructor(e,t){super(e,t),this.async=!0}work(e){return s(this,void 0,void 0,(function*(){if(this.testMode===n.TestMode.FAIL_GET_SPREADSHEET_SHEETS){let e=new Error("mock fail");throw new a.SyncerError(JSON.stringify(e),`Could not get spreadsheet information for ${this.payload.spreadsheetId}`,!1,!1,!0)}return this.payload.spreadsheet={spreadsheetId:this.payload.spreadsheetId,spreadsheetUrl:`https://docs.google.com/spreadsheets/d/${this.payload.spreadsheetId}/edit`,properties:{title:"Mock Journal"},sheets:[{properties:{sheetId:0,title:"Sheet1"}},{properties:{sheetId:1124780423,title:"Sheet2"}},{properties:{sheetId:1286561930,title:"Sheet3"}}]},this.payload}))}}t.MockGetSpreadsheetTask=d},8266:function(e,t,o){var s=this&&this.__awaiter||function(e,t,o,s){return new(o||(o=Promise))((function(r,n){function a(e){try{d(s.next(e))}catch(e){n(e)}}function i(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,i)}d((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=o(9703),n=o(9337),a=o(8037),i=o(1230);t.createUpdateRowTask=function(e,t){return t===i.TestMode.OFF?new d(e):new c(e,t)};class d extends r.BaseTask{constructor(e){super(e)}work(e){return s(this,void 0,void 0,(function*(){let t=`${this.payload.sheetTitle}!A${this.payload.idx+1}:A${this.payload.idx+1}`,o=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${this.payload.spreadsheetId}/values/${t}`),s={Authorization:`Bearer ${e}`},r={valueInputOption:"RAW"};Object.keys(r).forEach((e=>o.searchParams.append(e,r[e])));let d={method:"PUT",cache:"no-cache",headers:s,body:JSON.stringify({range:t,majorDimension:"ROWS",values:[[this.payload.content]]})},c=yield fetch(o.toString(),d),u=yield c.json();if(!c.ok){if(u.error.message.includes("exceeds grid limits")){let t={type:i.SyncerPayloadType.EXTEND_SHEET,spreadsheetId:this.payload.spreadsheetId,sheetId:this.payload.sheetId,rejects:!1};if(yield new n.ExtendSheetTask(t).work(e),(yield fetch(o.toString(),d)).ok)return this.payload;{let e=yield c.json();throw new a.SyncerError(JSON.stringify(e),"Failed to update entry",401===c.status)}}throw new a.SyncerError(JSON.stringify(u),"Failed to update entry",401===c.status)}return this.payload}))}}t.UpdateRowTask=d;class c extends r.BaseTask{constructor(e,t){super(e,t)}work(){return s(this,void 0,void 0,(function*(){if(this.testMode===i.TestMode.FAIL_UPDATE_RANGE){let e=new Error("mock fail");throw new a.SyncerError(JSON.stringify(e),"Failed to update entry",!1)}return this.payload}))}}t.MockUpdateRowTask=c},7155:(e,t,o)=>{function s(e){for(var o in e)t.hasOwnProperty(o)||(t[o]=e[o])}Object.defineProperty(t,"__esModule",{value:!0}),s(o(9703)),s(o(7094)),s(o(6680)),s(o(8266)),s(o(3494)),s(o(9337)),s(o(9636))},2197:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.instanceOfSyncerError=function(e){return"needsReAuth"in e}}},t={};!function o(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,o),n.exports}(3341)})();
//# sourceMappingURL=syncWebWorker.js.map