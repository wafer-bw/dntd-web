{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/types/index.ts","webpack:///./src/workers/sync/index.ts","webpack:///./src/types/search.ts","webpack:///./src/types/testing.ts","webpack:///./src/types/syncerTasks.ts","webpack:///./src/types/syncerResponses.ts","webpack:///./src/workers/sync/syncTasks.ts","webpack:///./src/workers/sync/typeGuards.ts","webpack:///./src/workers/sync/syncResponses.ts","webpack:///./src/mocks/index.ts","webpack:///./src/mocks/Gapi.ts","webpack:///./src/mocks/syncTasks.ts","webpack:///./src/workers/sync/syncWebWorker.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","syncRate","ms","Promise","resolve","setTimeout","SyncerError","Error","msg","needsReAuth","super","SearchType","TestMode","SyncerTaskType","SyncerResponseType","extendSheetLength","token","task","url","spreadsheetId","opts","method","cache","headers","Authorization","response","fetch","ok","json","sheets","error","JSON","stringify","status","range","sheetTitle","data","values","map","row","idx","URL","params","valueInputOption","keys","forEach","searchParams","append","body","majorDimension","content","toString","message","includes","this","extendSheet","sheetId","startRowIndex","endRowIndex","startColumnIndex","requests","deleteRange","shiftDimension","appendDimension","dimension","length","type","ROWS","SHEETS","QUEUE_STATE","ERROR","REAUTH","GET_SHEETS","AUTH_UPDATE","GET_ROWS","UPDATE_ROW","DELETE_ROW","TEST_MODE_UPDATE","UNPAUSE","postResponse","postMessage","rows","paused","auth2","MockAuth2","_api","_callback","MockGoogleAuth","_params","MockCurrentUser","MockGoogleUser","expires_in","access_token","isSignedIn","MockIsSignedIn","currentUser","listen","testMode","_token","_task","FAIL_GET_SPREADSHEET_SHEETS","FAIL_GET_RANGE","RETURN_ROWS","FAIL_UPDATE_RANGE","FAIL_DELETE_ROW","queue","syncerTasks","sleep","postQueueState","console","log","instanceOfGetRowsTask","postRows","getRows","instanceOfGetSheetsTask","postSheets","getSheets","instanceOfUpdateRowTask","updateRow","instanceOfDeleteRowTask","deleteRow","shift","e","instanceOfSyncerError","postReAuthRequest","postError","sync","onmessage","instanceOfTestModeUpdateTask","OFF","SyncerTasks","SyncerTasksMock","instanceOfAuthUpdateTask","instanceOfUnpauseTask","push"],"mappings":"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","file":"syncWebWorker.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 39);\n","export * from \"./caret\"\nexport * from \"./errors\"\nexport * from \"./search\"\nexport * from \"./testing\"\nexport * from \"./syncerTasks\"\nexport * from \"./syncerResponses\"\n","export * from \"./syncTasks\"\nexport * from \"./typeGuards\"\nexport * from \"./syncWebWorker\"\nexport * from \"./syncResponses\"\n\nexport const syncRate = 500 // ms\n\nexport async function sleep(ms: number) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport class SyncerError extends Error {\n    constructor(msg: string, public needsReAuth: boolean) {\n        super(msg)\n    }\n}\n","export enum SearchType {\n    NONE,\n    AND,\n    OR,\n}\n","export enum TestMode {\n    OFF = \"0\",\n    WORKING = \"1\",\n    FAIL_GET_SPREADSHEET_SHEETS = \"2\",\n    FAIL_GET_RANGE = \"3\",\n    FAIL_UPDATE_RANGE = \"4\",\n    FAIL_DELETE_ROW = \"5\",\n    RETURN_ROWS = \"6\",\n    DEMO = \"7\"\n}\n","import { TestMode } from \"./testing\"\n\nexport type SyncerTask = AuthUpdateTask | DeleteRowTask | UpdateRowTask | GetRowsTask | GetSheetsTask | TestModeUpdateTask | UnpauseTask\n\nexport enum SyncerTaskType {\n    AUTH_UPDATE,\n    DELETE_ROW,\n    UPDATE_ROW,\n    GET_ROWS,\n    GET_SHEETS,\n    TEST_MODE_UPDATE,\n    UNPAUSE\n}\n\nexport interface GetSheetsTask {\n    type: SyncerTaskType.GET_SHEETS\n    spreadsheetId: string\n}\n\nexport interface TestModeUpdateTask {\n    type: SyncerTaskType.TEST_MODE_UPDATE\n    testMode: TestMode\n}\n\nexport interface AuthUpdateTask {\n    type: SyncerTaskType.AUTH_UPDATE\n    token: string\n}\n\nexport interface DeleteRowTask {\n    type: SyncerTaskType.DELETE_ROW\n    idx: number\n    spreadsheetId: string\n    sheetId: number\n}\n\nexport interface UpdateRowTask {\n    type: SyncerTaskType.UPDATE_ROW\n    idx: number\n    spreadsheetId: string\n    sheetId: number\n    sheetTitle: string\n    content: string\n}\n\nexport interface GetRowsTask {\n    type: SyncerTaskType.GET_ROWS\n    spreadsheetId: string\n    sheetId: number\n    sheetTitle: string\n}\n\nexport interface UnpauseTask {\n    type: SyncerTaskType.UNPAUSE\n}","export type SyncerResponse = (\n    RowsResponse | SheetsResponse | QueueStateResponse | ErrorResponse | ReauthResponse\n)\n\nexport enum SyncerResponseType {\n    ROWS,\n    SHEETS,\n    QUEUE_STATE,\n    ERROR,\n    REAUTH,\n}\n\nexport interface RowsResponse {\n    type: SyncerResponseType.ROWS\n    spreadsheetId: string\n    sheetId: number\n    rows: string[]\n}\n\nexport interface SheetsResponse {\n    type: SyncerResponseType.SHEETS\n    spreadsheetId: string\n    sheets: gapi.client.sheets.Sheet[]\n}\n\nexport interface QueueStateResponse {\n    type: SyncerResponseType.QUEUE_STATE\n    length: number\n    paused: boolean\n}\n\nexport interface ErrorResponse {\n    type: SyncerResponseType.ERROR\n    error: Error\n}\n\nexport interface ReauthResponse {\n    type: SyncerResponseType.REAUTH\n}\n","import { SyncerError } from \".\"\nimport {\n    GetRowsTask, UpdateRowTask, DeleteRowTask, GapiErrorResponse, GetSheetsTask\n} from \"../../types\"\n\nexport class SyncerTasks {\n\n    public extendSheetLength = 100\n\n    public async getSheets(token: string, task: GetSheetsTask) {\n        let url = `https://sheets.googleapis.com/v4/spreadsheets/${task.spreadsheetId}`\n        let headers = { Authorization: `Bearer ${token}` }\n        let opts: RequestInit = { method: \"GET\", cache: \"no-cache\", headers: headers }\n        let response = await fetch(url, opts)\n        if (!response.ok) {\n            let error: GapiErrorResponse = await response.json()\n            throw new SyncerError(`Failed to get spreadsheet details.\\n${JSON.stringify(error)}`, response.status === 401)\n        } else {\n            let data: gapi.client.sheets.Spreadsheet = await response.json()\n            return data.sheets || []\n        }\n    }\n\n    public async getRows(token: string, task: GetRowsTask) {\n        let range = `${task.sheetTitle}!A:A`\n        let url = `https://sheets.googleapis.com/v4/spreadsheets/${task.spreadsheetId}/values/${range}`\n        let headers = { Authorization: `Bearer ${token}` }\n        let opts: RequestInit = { method: \"GET\", cache: \"no-cache\", headers: headers }\n        let response = await fetch(url, opts)\n        if (!response.ok) {\n            let error: GapiErrorResponse = await response.json()\n            throw new SyncerError(`Failed to get sheet rows.\\n${JSON.stringify(error)}`, response.status === 401)\n        } else {\n            let data: gapi.client.sheets.ValueRange = await response.json()\n            let rows: string[] = (data.values) ? data.values.map(row => row[0]) : []\n            return rows\n        }\n    }\n\n    public async updateRow(token: string, task: UpdateRowTask) {\n        let range = `${task.sheetTitle}!A${task.idx + 1}:A${task.idx + 1}`\n        let url = new URL(`https://sheets.googleapis.com/v4/spreadsheets/${task.spreadsheetId}/values/${range}`)\n        let headers = { Authorization: `Bearer ${token}` }\n        let params: Record<string, string> = { valueInputOption: \"RAW\" }\n        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]))\n        let body = JSON.stringify({ range: range, majorDimension: \"ROWS\", values: [[task.content]] })\n        let opts: RequestInit = { method: \"PUT\", cache: \"no-cache\", headers: headers, body: body }\n        let response = await fetch(url.toString(), opts)\n        let data = await response.json()\n        if (!response.ok) {\n            if (data.error.message.includes(\"exceeds grid limits\")) {\n                await this.extendSheet(token, task.spreadsheetId, task.sheetId)\n                let secondResponse = await fetch(url.toString(), opts)\n                if (!secondResponse.ok) {\n                    let error: GapiErrorResponse = await response.json()\n                    throw new SyncerError(`Failed to update row:\\n${JSON.stringify(error)}`, response.status === 401)\n                } else {\n                    return\n                }\n            }\n            throw new SyncerError(`Failed to update row:\\n${JSON.stringify(data)}`, response.status === 401)\n        }\n    }\n\n    public async deleteRow(token: string, task: DeleteRowTask) {\n        let range = { sheetId: task.sheetId, startRowIndex: task.idx, endRowIndex: task.idx + 1, startColumnIndex: 0 }\n        let url = new URL(`https://sheets.googleapis.com/v4/spreadsheets/${task.spreadsheetId}:batchUpdate`)\n        let headers = { Authorization: `Bearer ${token}` }\n        let body = JSON.stringify({ requests: [{ deleteRange: { range: range, shiftDimension: \"ROWS\" } }] })\n        let opts: RequestInit = { method: \"POST\", cache: \"no-cache\", headers: headers, body: body }\n        let response = await fetch(url.toString(), opts)\n        if (!response.ok) {\n            let error: GapiErrorResponse = await response.json()\n            throw new SyncerError(`Failed to delete row.\\n${JSON.stringify(error)}`, response.status === 401)\n        }\n    }\n\n    private async extendSheet(token: string, spreadsheetId: string, sheetId: number) {\n        let url = new URL(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`)\n        let headers = { Authorization: `Bearer ${token}` }\n        let body = JSON.stringify({ requests: [{ appendDimension: { sheetId: sheetId, dimension: \"ROWS\", length: this.extendSheetLength } }] })\n        let opts: RequestInit = { method: \"POST\", mode: \"cors\", cache: \"no-cache\", headers: headers, body: body }\n        let response = await fetch(url.toString(), opts)\n        if (!response.ok) {\n            let error: GapiErrorResponse = await response.json()\n            throw new SyncerError(`Failed to extend sheet.\\n${JSON.stringify(error)}`, response.status === 401)\n        }\n    }\n\n}\n","import { SyncerError } from \".\"\nimport {\n    SyncerTask, AuthUpdateTask, SyncerTaskType, GetRowsTask, UpdateRowTask,\n    DeleteRowTask,SyncerResponse, RowsResponse, SyncerResponseType,\n    SheetsResponse, QueueStateResponse, GetSheetsTask, TestModeUpdateTask,\n    ErrorResponse, UnpauseTask, ReauthResponse\n} from \"../../types\"\n\nexport function instanceOfSyncerError(error: Error | SyncerError): error is SyncerError {\n    return \"needsReAuth\" in error\n}\n\nexport function instanceOfRowsResponse(response: SyncerResponse): response is RowsResponse {\n    return \"type\" in response && response.type === SyncerResponseType.ROWS\n}\n\nexport function instanceOfSheetsResponse(response: SyncerResponse): response is SheetsResponse {\n    return \"type\" in response && response.type === SyncerResponseType.SHEETS\n}\n\nexport function instanceOfQueueStateResponse(response: SyncerResponse): response is QueueStateResponse {\n    return \"type\" in response && response.type === SyncerResponseType.QUEUE_STATE\n}\n\nexport function instanceOfErrorResponse(response: SyncerResponse): response is ErrorResponse {\n    return \"type\" in response && response.type === SyncerResponseType.ERROR\n}\n\nexport function instanceOfReauthResponse(response: SyncerResponse): response is ReauthResponse {\n    return \"type\" in response && response.type === SyncerResponseType.REAUTH\n}\n\nexport function instanceOfGetSheetsTask(task: SyncerTask): task is GetSheetsTask {\n    return \"type\" in task && task.type === SyncerTaskType.GET_SHEETS\n}\n\nexport function instanceOfAuthUpdateTask(task: SyncerTask): task is AuthUpdateTask {\n    return \"type\" in task && task.type === SyncerTaskType.AUTH_UPDATE\n}\n\nexport function instanceOfGetRowsTask(task: SyncerTask): task is GetRowsTask {\n    return \"type\" in task && task.type === SyncerTaskType.GET_ROWS\n}\n\nexport function instanceOfUpdateRowTask(task: SyncerTask): task is UpdateRowTask {\n    return \"type\" in task && task.type === SyncerTaskType.UPDATE_ROW\n}\n\nexport function instanceOfDeleteRowTask(task: SyncerTask): task is DeleteRowTask {\n    return \"type\" in task && task.type === SyncerTaskType.DELETE_ROW\n}\n\nexport function instanceOfTestModeUpdateTask(task: SyncerTask): task is TestModeUpdateTask {\n    return \"type\" in task && task.type === SyncerTaskType.TEST_MODE_UPDATE\n}\n\nexport function instanceOfUnpauseTask(task: SyncerTask): task is UnpauseTask {\n    return \"type\" in task && task.type === SyncerTaskType.UNPAUSE\n}\n","import { SyncerError } from \".\"\nimport { \n    SyncerResponse, SyncerResponseType, GetRowsTask, GetSheetsTask\n} from \"../../types\"\n\nexport function postSheets(task: GetSheetsTask, sheets: gapi.client.sheets.Sheet[]) {\n    postResponse({\n        spreadsheetId: task.spreadsheetId,\n        sheets: sheets,\n        type: SyncerResponseType.SHEETS\n    })\n}\n\nexport function postRows(task: GetRowsTask, rows: string[]) {\n    postResponse({\n        spreadsheetId: task.spreadsheetId,\n        sheetId: task.sheetId,\n        rows: rows,\n        type: SyncerResponseType.ROWS\n    })\n}\n\nexport function postQueueState(length: number, paused: boolean) {\n    postResponse({\n        length: length,\n        paused: paused,\n        type: SyncerResponseType.QUEUE_STATE\n    })\n}\n\nexport function postError(error: Error | SyncerError) {\n    postResponse({\n        error: error,\n        type: SyncerResponseType.ERROR\n    })\n}\n\nexport function postReAuthRequest() {\n    postMessage({ type: SyncerResponseType.REAUTH })\n}\n\nfunction postResponse(response: SyncerResponse) {\n    postMessage(response)\n}\n","export * from \"./Gapi\"\nexport * from \"./syncTasks\"\n","export class MockGapi {\n    public auth2 = new MockAuth2()\n    public load(_api: string, _callback: () => void) {\n        _callback()\n    }\n}\n\nclass MockAuth2 {\n    public getAuthInstance() {\n        return new MockGoogleAuth()\n    }\n    public async init(_params: any) { }\n}\n\nclass MockCurrentUser {\n    public get() { return new MockGoogleUser() }\n}\n\nexport class MockGoogleUser {\n    public getAuthResponse() {\n        return {\n            expires_in: 9999,\n            access_token: \"faketoken\"\n        }\n    }\n    public async reloadAuthResponse() {\n        return {\n            expires_in: 9999,\n            access_token: \"faketoken\"\n        }\n    }\n}\n\nclass MockGoogleAuth {\n    public isSignedIn = new MockIsSignedIn()\n    public signOut() { }\n    public signIn() { }\n    public currentUser = new MockCurrentUser()\n}\n\nclass MockIsSignedIn {\n    public listen = (_callback: any) => { }\n    public get = () => { return true }\n}\n","import {\n    GetRowsTask, UpdateRowTask, DeleteRowTask, GetSheetsTask, TestMode\n} from \"../types\"\n\nexport class SyncerTasksMock {\n\n    public extendSheetLength = 100\n\n    constructor(private testMode: TestMode) { }\n\n    public async getSheets(_token: string, _task: GetSheetsTask) {\n        if (this.testMode === TestMode.FAIL_GET_SPREADSHEET_SHEETS) {\n            throw new Error(\"mock fail\")\n        }\n        return [{\n            \"properties\": {\n                \"sheetId\": 0,\n                \"title\": \"Sheet1\",\n                \"index\": 0,\n                \"sheetType\": \"GRID\",\n                \"gridProperties\": {\n                    \"rowCount\": 100,\n                    \"columnCount\": 26\n                }\n            }\n        },\n        {\n            \"properties\": {\n                \"sheetId\": 1,\n                \"title\": \"Sheet2\",\n                \"index\": 0,\n                \"sheetType\": \"GRID\",\n                \"gridProperties\": {\n                    \"rowCount\": 100,\n                    \"columnCount\": 26\n                }\n            }\n        }]\n    }\n\n    public async getRows(_token: string, _task: GetRowsTask) {\n        if (this.testMode === TestMode.FAIL_GET_RANGE) {\n            throw new Error(\"mock fail\")\n        } else if (this.testMode === TestMode.RETURN_ROWS) {\n            return [\"aaa\", \"bbb\", \"ccc\", \"@tag\", \"@key:value\"]\n        }\n        return []\n    }\n\n    public async updateRow(_token: string, _task: UpdateRowTask) {\n        if (this.testMode === TestMode.FAIL_UPDATE_RANGE) {\n            throw new Error(\"mock fail\")\n        }\n    }\n\n    public async deleteRow(_token: string, _task: DeleteRowTask) {\n        if (this.testMode === TestMode.FAIL_DELETE_ROW) {\n            throw new Error(\"mock fail\")\n        }\n    }\n\n}\n","import { SyncerTasksMock } from \"../../mocks\"\nimport { TestMode, SyncerTask } from \"../../types\"\nimport {\n    instanceOfAuthUpdateTask, instanceOfGetRowsTask, instanceOfUpdateRowTask,\n    instanceOfDeleteRowTask, instanceOfGetSheetsTask, instanceOfTestModeUpdateTask,\n    SyncerTasks, postQueueState, postRows, postSheets, syncRate, sleep, postError,\n    postReAuthRequest, instanceOfUnpauseTask, instanceOfSyncerError\n} from \".\"\n\nconst queue: any[] = []\nlet paused: boolean = false\nlet token: string | null = null\nlet syncerTasks: SyncerTasks | SyncerTasksMock | null = null\n\nsync()\n\nonmessage = (msg) => {\n    let task: SyncerTask = msg.data\n    if (instanceOfTestModeUpdateTask(task)) {\n        if (task.testMode === TestMode.OFF) {\n            syncerTasks = new SyncerTasks()\n        } else {\n            token = \"mock\"\n            syncerTasks = new SyncerTasksMock(task.testMode)\n        }\n    } else if (instanceOfAuthUpdateTask(task)) {\n        token = task.token\n    } else if (instanceOfUnpauseTask(task)) {\n        paused = false\n    } else {\n        queue.push(task)\n    }\n}\n\nasync function sync() {\n    while (true) {\n        await sleep(syncRate)\n        postQueueState(queue.length, paused)\n        console.log(queue)\n        while (queue.length > 0 && token && !paused && syncerTasks) {\n            let task: SyncerTask = queue[0]\n            try {\n                if (instanceOfGetRowsTask(task)) {\n                    postRows(task, await syncerTasks!.getRows(token!, task))\n                } else if (instanceOfGetSheetsTask(task)) {\n                    postSheets(task, await syncerTasks!.getSheets(token!, task))\n                } else if (instanceOfUpdateRowTask(task)) {\n                    await syncerTasks!.updateRow(token!, task)\n                } else if (instanceOfDeleteRowTask(task)) {\n                    await syncerTasks!.deleteRow(token!, task)\n                }\n                queue.shift()\n            } catch (e) {\n                if (instanceOfSyncerError(e) && e.needsReAuth) {\n                    postReAuthRequest()\n                    token = null\n                    break\n                } else {\n                    paused = true\n                    postError(e)\n                    break\n                }\n            }\n        }\n    }\n}\n"],"sourceRoot":""}