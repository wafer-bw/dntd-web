{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"m\"","webpack:///./src/types/index.ts","webpack:///./src/controllers/index.ts","webpack:///./src/index.ts","webpack:///./src/factories/index.ts","webpack:///./src/components/index.ts","webpack:///./src/models/index.ts","webpack:///./src/errors/index.ts","webpack:///./src/controllers/urlController.ts","webpack:///./src/types/errors.ts","webpack:///./src/types/search.ts","webpack:///./src/types/testing.ts","webpack:///./src/types/syncer.ts","webpack:///./src/controllers/entryController.ts","webpack:///./src/models/SearchModel.ts","webpack:///./src/controllers/syncerController.ts","webpack:///./src/controllers/journalController.ts","webpack:///./src/views/index.ts","webpack:///./src/views/shelfView.ts","webpack:///./src/components/googleComponent.ts","webpack:///./src/controllers/textController.ts","webpack:///./src/factories/tagFactory.ts","webpack:///./src/models/UrlModel.ts","webpack:///./src/models/TagModel.ts","webpack:///./src/models/EntryModel.ts","webpack:///./src/models/ShelfModel.ts","webpack:///./src/models/SyncerModel.ts","webpack:///./src/models/GoogleModel.ts","webpack:///./src/models/JournalModel.ts","webpack:///./src/models/LibraryModel.ts","webpack:///./src/models/AppStateModel.ts","webpack:///./src/models/ServiceWorkerModel.ts","webpack:///./src/errors/FriendlyError.ts","webpack:///./src/factories/shelfFactory.ts","webpack:///./src/factories/entryFactory.ts","webpack:///./src/controllers/caretController.ts","webpack:///./src/controllers/searchController.ts","webpack:///./src/controllers/googleController.ts","webpack:///./src/mocks/index.ts","webpack:///./src/mocks/Gapi.ts","webpack:///./src/controllers/libraryController.ts","webpack:///./src/controllers/appStateController.ts","webpack:///./src/components/composeComponent.ts","webpack:///./src/components/entriesComponent.ts","webpack:///./src/components/shelvesComponent.ts","webpack:///./src/components/refinesComponent.ts","webpack:///./src/components/testModeComponent.ts","webpack:///./src/components/journalsComponent.ts","webpack:///./src/components/syncStateComponent.ts","webpack:///./src/components/searchbarComponent.ts","webpack:///./src/components/addShelvesComponent.ts","webpack:///./src/components/breadcrumbComponent.ts","webpack:///./src/views/signinView.ts","webpack:///./src/views/libraryView.ts","webpack:///./src/views/journalView.ts","webpack:///./src/views/testModeView.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","appStateModel","AppStateModel","serviceWorkerModel","ServiceWorkerModel","googleModel","GoogleModel","syncerModel","SyncerModel","libraryModel","LibraryModel","urlModel","UrlModel","searchModel","SearchModel","root","document","getElementById","route","signinView","testModeView","libraryView","shelfView","journalView","getActiveShelf","id","shelfId","undefined","shelves","urlController","redirect","hash","getActiveJournal","journalId","shelf","journals","getBreadcrumbTrail","breadcrumb","split","filter","crumb","length","trail","slice","join","title","parseInt","push","href","SyncerError","Error","errorMsg","friendlyMsg","needsReAuth","pause","super","this","payload","error","type","SyncerPayloadType","ERROR","SearchType","TestMode","str","values","includes","SyncerResponseType","SyncerState","tagPattern","entryController","save","entry","entryIdx","content","sync","force","saved","savedClean","textController","clean","tags","tagMatches","Map","tag","has","frq","set","getTags","syncerController","updateRow","journal","update","raw","safe","escape","tokens","text","token","trim","matchesIter","matchAll","match","tagFactory","createTag","sort","a","b","index","getTagMatches","rendered","chars","splice","render","searchType","NONE","simpleRefines","complexRefines","barQuery","entryFactory","createBaseEntry","refinesQuery","keys","Set","vals","simpleKeys","Array","from","worker","Worker","updateAuth","pushSyncerTask","AUTH_UPDATE","onmessage","msg","data","requests","delete","FriendlyError","SYNC_STATE","state","redraw","message","TOKEN_REQUEST","onMessage","unpause","UNPAUSE","getRows","journalTitle","GET_ROWS","spreadsheetId","sheetTitle","sheetId","rows","deleteRow","idx","DELETE_ROW","UPDATE_ROW","updateTestMode","testMode","TEST_MODE_UPDATE","getSpreadsheet","GET_SPREADSHEET","spreadsheet","addEntry","createJournalEntry","createEntry","buildTags","entries","reverse","flag","separator","val","searchController","buildRefines","journalController","moveEntry","fromIdx","toIdx","deleteEntry","loadEntries","keepJournal","forEach","loaded","unloadEntries","then","catch","finally","view","googleComponent","testModeComponent","syncStateComponent","breadcrumbComponent","journalsComponent","isSignedIn","onclick","googleController","signOut","class","signIn","async","defer","src","onload","initGapi","unsafe","replace","toLowerCase","cleanTagString","endsWith","substring","cleanKey","cleanVal","renderedKey","renderedVal","TagModel","window","location","hash_","URL","url","searchParams","param","BaseEntryModel","entryId","requestsCounter","INITIALIZING","Promise","resolve","reject","postMessage","scope","clientId","user","getAuthResponse","access_token","shelfIds","ids","localStorage","removeItem","setItem","getItem","OFF","navigator","addEventListener","serviceWorker","register","console","warn","shelfFactory","createShelf","properties","sheets","ShelfModel","sheet","JournalModel","getJournals","entryCounter","JournalEntryModel","caretController","getCaretPosition","elem","sel","getSelection","cum_length","anchorNode","innerText","extentNode","nodes_to_find","contains","found","node_walk","node","func","result","firstChild","nextSibling","textContent","anchorOffset","extentOffset","setCaretPosition","el","pos","childNodes","nodeType","range","createRange","setStart","collapse","removeAllRanges","addRange","search","query","sourceEntries","filteredEntries","AND","every","OR","some","startsWith","reset","cleanRefines","map","updateSearchbar","signedIn","gapi_","auth2","getAuthInstance","currentUser","libraryController","loadShelves","removeShelves","gapi","MockGapi","load","init","client_id","listen","MockAuth2","_api","_callback","MockGoogleAuth","_params","MockCurrentUser","MockGoogleUser","expires_in","MockIsSignedIn","spreadsheetIdPattern","reloadLoaded","getSpreadsheetIdsFromUrls","urls","addShelves","appStateController","instanceOfTestMode","caret","composePrefixEntry","composeContentEntry","composeSuffixEntry","prefixSettings","entrySettings","suffixSettings","composeNodeSettings","extraSettings","baseSettings","contenteditable","onkeydown","event","keyCode","shiftKey","preventDefault","composeKeydown","oninput","target","composeInput","onupdate","assign","trust","entriesList","entryContent","deleteEntryButton","entryVnode","blur","onEntryKeydown","onEntryInput","onEntryUpdate","onblur","onEntryBlur","entryContentSettings","delShelfButton","retryShelfLoadButton","shelfNode","expanded","simpleRefinesVnodes","size","refineKeyVnode","refineValVnode","count","metaKey","ctrlKey","add","refineTagKeyOnClick","tagRefineKeySettings","checked","tagRefineValSettings","tagClass","hideClass","refineTagValOnClick","stopDemoButton","DEMO","link","journalList","syncStateText","txt","class_","stateColorClass","DOWNLOADING","PAUSED","SYNCED","UPLOADING","syncStateIcon","unpauseSync","placeholder","onSearchInput","onSearchKeydown","newShelfUrls","addingShelves","addShelvesMessage","addShelvesButton","addShelvesTextbox","addShelvesComponent","shelvesComponent","searchbarComponent","refinesComponent","entriesComponent","composeComponent","oninit","getParam"],"mappings":"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","file":"dntd.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n","module.exports = m;","export * from \"./caret\"\nexport * from \"./errors\"\nexport * from \"./search\"\nexport * from \"./testing\"\nexport * from \"./syncer\"\n","export * from \"./urlController\"\r\nexport * from \"./textController\"\r\nexport * from \"./entryController\"\r\nexport * from \"./caretController\"\r\nexport * from \"./searchController\"\r\nexport * from \"./googleController\"\r\nexport * from \"./syncerController\"\r\nexport * from \"./libraryController\"\r\nexport * from \"./journalController\"\r\nexport * from \"./appStateController\"\r\n","import m from \"mithril\"\nimport { signinView, libraryView, shelfView, journalView, testModeView } from \"./views\"\nimport {\n    ServiceWorkerModel, SyncerModel, LibraryModel, GoogleModel, UrlModel, SearchModel, AppStateModel\n} from \"./models\"\n\nexport const appStateModel = new AppStateModel()\nexport const serviceWorkerModel = new ServiceWorkerModel()\nexport const googleModel = new GoogleModel()\nexport const syncerModel = new SyncerModel()\nexport const libraryModel = new LibraryModel()\nexport const urlModel = new UrlModel()\nexport const searchModel = new SearchModel()\n\nconst root = document.getElementById(\"root\")\n\nif (root !== null) {\n    m.route(root, \"/\", {\n        \"/\": signinView,        // TODO switch to be about page\n        \"/demo\": testModeView,\n        \"/signin\": signinView,\n        \"/library\": libraryView,\n        \"/library/:shelfId\": shelfView,\n        \"/setTestMode/:testMode\": testModeView,\n        \"/library/:shelfId/:journalId\": journalView,\n    })\n}\n","export * from \"./tagFactory\"\nexport * from \"./shelfFactory\"\nexport * from \"./entryFactory\"\n","export * from \"./googleComponent\"\nexport * from \"./composeComponent\"\nexport * from \"./entriesComponent\"\nexport * from \"./shelvesComponent\"\nexport * from \"./refinesComponent\"\nexport * from \"./testModeComponent\"\nexport * from \"./journalsComponent\"\nexport * from \"./syncStateComponent\"\nexport * from \"./searchbarComponent\"\nexport * from \"./addShelvesComponent\"\nexport * from \"./breadcrumbComponent\"","export * from \"./UrlModel\"\r\nexport * from \"./TagModel\"\r\nexport * from \"./EntryModel\"\r\nexport * from \"./ShelfModel\"\r\nexport * from \"./SyncerModel\"\r\nexport * from \"./SearchModel\"\r\nexport * from \"./GoogleModel\"\r\nexport * from \"./SearchModel\"\r\nexport * from \"./JournalModel\"\r\nexport * from \"./LibraryModel\"\r\nexport * from \"./AppStateModel\"\r\nexport * from \"./ServiceWorkerModel\"\r\n","export * from \"./FriendlyError\"\n","import m from \"mithril\"\nimport { libraryModel, urlModel } from \"..\"\nimport { ShelfModel, JournalModel } from \"../models\"\n\nexport const urlController = {\n    redirect: redirect,\n    getActiveShelf: getActiveShelf,\n    getActiveJournal: getActiveJournal,\n    getBreadcrumbTrail: getBreadcrumbTrail,\n}\n\nfunction redirect(hash: string) {\n    urlModel.hash = hash\n}\n\nfunction getActiveShelf(): ShelfModel | undefined {\n    let id = urlModel.shelfId\n    if (id === undefined) return undefined\n    return libraryModel.shelves.get(id)\n}\n\nfunction getActiveJournal(): JournalModel | undefined {\n    let id = urlModel.journalId\n    let shelf = getActiveShelf()\n    if (id === undefined || shelf === undefined) return undefined\n    return shelf.journals.get(id)\n}\n\nfunction getBreadcrumbTrail() {\n    let breadcrumb: m.Vnode[] = []\n    let hash = urlModel.hash.split(\"?\")[0].split(\"/\").filter(crumb => crumb !== \"#\" && crumb !== \"\")\n    let shelfId: string | undefined = undefined\n    for (let i = 0; i < hash.length; i++) {\n        let crumb = hash[i]\n        let trail = \"#/\" + hash.slice(0, i + 1).join(\"/\")\n        if (i === 2) {\n            shelfId = crumb\n            crumb = libraryModel.shelves.get(crumb)?.title || crumb\n        } else if (i === 3 && shelfId !== undefined) {\n            crumb = libraryModel.shelves.get(shelfId)?.journals.get(parseInt(crumb))?.title || crumb\n        }\n        if (i !== 0) breadcrumb.push(m(\"span\", \" / \"))\n        if (i === hash.length - 1) {\n            breadcrumb.push(m(\"span\", `${crumb}`))\n        } else {\n            breadcrumb.push(m(\"a\", { href: trail }, `${crumb}`))\n        }\n    }\n    return breadcrumb\n}\n","import { ErrorPayload, SyncerPayloadType } from \".\"\n\nexport interface GapiErrorResponseBody {\n    code: number,\n    message: string,\n    status: string\n}\n\nexport interface GapiErrorResponse {\n    error: GapiErrorResponseBody\n}\n\nexport class SyncerError extends Error { // TODO: see if this can be moved to src/errors/\n    public payload: ErrorPayload\n\n    constructor(errorMsg: string, public friendlyMsg: string, public needsReAuth: boolean, pause?: boolean) {\n        super(errorMsg)\n        this.payload = {\n            pause: (pause !== undefined) ? pause : true,\n            error: this,\n            friendlyMsg: this.friendlyMsg,\n            type: SyncerPayloadType.ERROR,\n        }\n    }\n}\n","export enum SearchType {\n    NONE,\n    AND,\n    OR,\n}\n","export enum TestMode {\n    OFF = \"0\",\n    WORKING = \"1\",\n    FAIL_GET_SPREADSHEET_SHEETS = \"2\",\n    FAIL_GET_RANGE = \"3\",\n    FAIL_UPDATE_RANGE = \"4\",\n    FAIL_DELETE_ROW = \"5\",\n    RETURN_ROWS = \"6\",\n    DEMO = \"demomode\"\n}\n\nexport function instanceOfTestMode(str: string): str is TestMode {\n    return ((<any>Object).values(TestMode).includes(str))\n}\n","import { TestMode } from \"./testing\"\n\nexport type SyncerPayload = (\n    GetRowsPayload | GetSpreadsheetPayload | UpdateRowPayload |\n    ExtendSheetPayload | DeleteRowPayload | TestModeUpdatePayload | AuthUpdatePayload |\n    UnpausePayload | SyncStatePayload | ErrorPayload | TokenRequestPayload\n)\n\nexport enum SyncerPayloadType {\n    AUTH_UPDATE,\n    DELETE_ROW,\n    UPDATE_ROW,\n    GET_ROWS,\n    TEST_MODE_UPDATE,\n    UNPAUSE,\n    GET_SPREADSHEET,\n    EXTEND_SHEET,\n    CREATE_ROW,\n    MOVE_ROW,\n    ERROR,\n    TOKEN_REQUEST,\n    SYNC_STATE,\n}\n\nexport enum SyncerResponseType {\n    SYNCER_STATE,\n    ERROR,\n    REAUTH,\n}\n\nexport enum SyncerState {\n    PAUSED = \"cloud_off\",\n    UPLOADING = \"cloud_upload\",\n    DOWNLOADING = \"cloud_download\",\n    SYNCED = \"cloud_done\",\n    INITIALIZING = \"cloud_queue\",\n}\n\nexport interface TestModeUpdatePayload {\n    type: SyncerPayloadType.TEST_MODE_UPDATE\n    testMode: TestMode\n}\n\nexport interface AuthUpdatePayload {\n    type: SyncerPayloadType.AUTH_UPDATE\n    token: string\n}\n\nexport interface UnpausePayload {\n    type: SyncerPayloadType.UNPAUSE\n}\n\nexport interface DeleteRowPayload {\n    type: SyncerPayloadType.DELETE_ROW\n    idx: number\n    spreadsheetId: string\n    sheetId: number\n}\n\nexport interface ExtendSheetPayload {\n    type: SyncerPayloadType.EXTEND_SHEET\n    spreadsheetId: string\n    sheetId: number\n}\n\nexport interface UpdateRowPayload {\n    type: SyncerPayloadType.UPDATE_ROW\n    idx: number\n    spreadsheetId: string\n    sheetId: number\n    sheetTitle: string\n    content: string\n}\n\nexport interface GetSpreadsheetPayload {\n    type: SyncerPayloadType.GET_SPREADSHEET\n    spreadsheetId: string\n    spreadsheet?: gapi.client.sheets.Spreadsheet\n}\n\nexport interface GetRowsPayload {\n    type: SyncerPayloadType.GET_ROWS\n    spreadsheetId: string\n    sheetId: number\n    sheetTitle: string\n    rows: string[]\n}\n\nexport interface SyncStatePayload {\n    type: SyncerPayloadType.SYNC_STATE\n    length: number\n    state: SyncerState\n}\n\nexport interface ErrorPayload {\n    type: SyncerPayloadType.ERROR\n    error: Error\n    pause: boolean\n    friendlyMsg: string\n}\n\nexport interface TokenRequestPayload {\n    type: SyncerPayloadType.TOKEN_REQUEST\n}\n","import { tagFactory } from \"../factories\"\nimport { JournalEntryModel, TagModel, BaseEntryModel } from \"../models\"\nimport { textController, syncerController } from \".\"\n\nconst tagPattern = /(\\@)([\\w-']+)+(:)?([\\w-'\\*]+)?/g\n\nexport const entryController = {\n    save: save,\n    update: update,\n}\n\nfunction save(entry: JournalEntryModel, entryIdx: number, content: string, sync?: boolean, force?: boolean) {\n    if (entry.saved !== content || force) {\n        entry.saved = content\n        entry.savedClean = textController.clean(entry.saved)\n        entry.tags = getTags(entry.tagMatches)\n        if (sync) {\n            syncerController.updateRow(entry.shelf.id, entry.journal.id, entry.journal.title, entryIdx, content)\n        }\n    }\n}\n\nfunction update(entry: BaseEntryModel | JournalEntryModel, content: string) {\n    entry.raw = content\n    entry.clean = textController.clean(content)\n    entry.safe = textController.escape(entry.raw)\n    entry.tokens = tokenize(entry.clean)\n    entry.tagMatches = getTagMatches(entry.safe)\n    entry.rendered = render(entry.safe, entry.tagMatches)\n}\n\nfunction render(text: string, tagMatches: { tag: TagModel, match: RegExpMatchArray }[]): string {\n    for (let { tag, match } of tagMatches) {\n        let chars = text.split(\"\")\n        chars.splice(match.index!, match[0].length, tag.rendered)\n        text = chars.join(\"\")\n    }\n    return text\n}\n\nfunction getTags(tagMatches: { tag: TagModel, match: RegExpMatchArray }[]): Map<string, TagModel> {\n    let tags: Map<string, TagModel> = new Map()\n    for (let { tag } of tagMatches) {\n        if (tags.has(tag.clean)) {\n            tags.get(tag.clean)!.frq += 1\n        } else {\n            tags.set(tag.clean, tag)\n        }\n    }\n    return tags\n}\n\nfunction getTagMatches(text: string): { tag: TagModel, match: RegExpMatchArray }[] {\n    let tagMatches = []\n    let matchesIter = text.matchAll(tagPattern)\n    for (let match of matchesIter) {\n        let tag = tagFactory.createTag(match[0], match[1], match[2], match[3], match[4])\n        tagMatches.push({ tag: tag, match: match })\n    }\n    tagMatches.sort((a, b) => (a.match.index! > b.match.index!) ? -1 : 1)\n    return tagMatches\n}\n\nfunction tokenize(text: string): string[] {\n    let tokens = text.split(\" \")\n    return tokens.filter(token => {\n        return token !== undefined && token.trim() !== \"\" && token !== \"-\"\n    })\n}\n","import { SearchType } from \"../types\"\nimport { entryFactory } from \"../factories\"\nimport { TagModel, BaseEntryModel } from \".\"\n\nexport class SearchModel {\n    public searchType: SearchType = SearchType.NONE\n    public simpleRefines: Map<string, TagModel> = new Map()\n    public complexRefines: Map<string, TagModel[]> = new Map()\n    public barQuery: BaseEntryModel = entryFactory.createBaseEntry()\n    public refinesQuery: {\n        keys: Set<string>,\n        vals: Map<string, TagModel>,\n        simpleKeys: Map<string, TagModel>\n    } = { keys: new Set(), vals: new Map(), simpleKeys: new Map() }\n\n    constructor() { }\n\n    get query(): BaseEntryModel {\n        return entryFactory.createBaseEntry([\n            this.barQuery.raw,\n            ...Array.from(this.refinesQuery.keys.values()),\n            ...Array.from(this.refinesQuery.vals.keys()),\n            ...Array.from(this.refinesQuery.simpleKeys.keys())\n        ].join(\" \"))\n    }\n\n}\n","import m from \"mithril\"\r\nimport { FriendlyError } from \"../errors\"\r\nimport { googleModel, syncerModel } from \"..\"\r\nimport { SyncerPayloadType, TestMode, SyncerPayload, ErrorPayload } from \"../types\"\r\n\r\nconst worker = new Worker(\"./js/syncWebWorker.js\")\r\nworker.onmessage = (msg: MessageEvent) => onMessage(msg)\r\n\r\nexport const syncerController = {\r\n    unpause: unpause,\r\n    getRows: getRows,\r\n    deleteRow: deleteRow,\r\n    updateRow: updateRow,\r\n    updateAuth: updateAuth,\r\n    updateTestMode: updateTestMode,\r\n    getSpreadsheet: getSpreadsheet,\r\n}\r\n\r\nasync function updateTestMode(testMode: TestMode) {\r\n    return await syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.TEST_MODE_UPDATE,\r\n        testMode: testMode,\r\n    }, worker)\r\n}\r\n\r\nfunction updateAuth(token: string | undefined) {\r\n    if (token === undefined) return\r\n    return syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.AUTH_UPDATE,\r\n        token: token,\r\n    }, worker)\r\n}\r\n\r\nfunction getSpreadsheet(spreadsheetId: string) {\r\n    let spreadsheet: gapi.client.sheets.Spreadsheet | undefined = undefined\r\n    return syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.GET_SPREADSHEET,\r\n        spreadsheetId: spreadsheetId,\r\n        spreadsheet: spreadsheet\r\n    }, worker)\r\n}\r\n\r\nfunction getRows(shelfId: string, journalId: number, journalTitle: string) {\r\n    let rows: string[] = []\r\n    return syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.GET_ROWS,\r\n        spreadsheetId: shelfId,\r\n        sheetTitle: journalTitle,\r\n        sheetId: journalId,\r\n        rows: rows\r\n    }, worker)\r\n}\r\n\r\nasync function deleteRow(idx: number, spreadsheetId: string, sheetId: number) {\r\n    return await syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.DELETE_ROW,\r\n        spreadsheetId: spreadsheetId,\r\n        sheetId: sheetId,\r\n        idx: idx,\r\n    }, worker)\r\n}\r\n\r\nasync function updateRow(shelfId: string, journalId: number, journalTitle: string, idx: number, content: string) {\r\n    return await syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.UPDATE_ROW,\r\n        spreadsheetId: shelfId,\r\n        sheetTitle: journalTitle,\r\n        sheetId: journalId,\r\n        content: content,\r\n        idx: idx,\r\n    }, worker)\r\n}\r\n\r\n// TODO: createRow\r\n\r\n// TODO: moveRow\r\n\r\nasync function unpause() {\r\n    return await syncerModel.pushSyncerTask({\r\n        type: SyncerPayloadType.UNPAUSE\r\n    }, worker)\r\n}\r\n\r\nfunction onMessage(msg: MessageEvent) {\r\n    let { id, payload, error }: { id: string | null, payload: SyncerPayload, error: ErrorPayload } = msg.data\r\n    if (id !== null && syncerModel.requests.has(id)) {\r\n        syncerModel.requests.get(id)!({ payload, error })\r\n        syncerModel.requests.delete(id)\r\n    } else if (payload !== undefined) {\r\n        switch (payload.type) {\r\n            case SyncerPayloadType.SYNC_STATE:\r\n                syncerModel.state = payload.state\r\n                m.redraw()\r\n                break\r\n            case SyncerPayloadType.ERROR:\r\n                new FriendlyError(payload.error.message, payload.friendlyMsg)\r\n                break\r\n            case SyncerPayloadType.TOKEN_REQUEST:\r\n                updateAuth(googleModel.token)\r\n                break\r\n        }\r\n    } else {\r\n        throw new FriendlyError(\"undefined payload\", \"An unexpected error occurred.\")\r\n    }\r\n}\r\n","import m from \"mithril\"\nimport { libraryModel } from \"..\"\nimport { ErrorPayload } from \"../types\"\nimport { FriendlyError } from \"../errors\"\nimport { JournalModel, TagModel } from \"../models\"\nimport { tagFactory, entryFactory } from \"../factories\"\nimport { syncerController, searchController, entryController } from \".\"\n\nexport const journalController = {\n    addEntry: addEntry,\n    moveEntry: moveEntry,\n    buildTags: buildTags,\n    deleteEntry: deleteEntry,\n    loadEntries: loadEntries,\n}\n\nfunction unloadOtherJournals(keepJournal: JournalModel) {\n    libraryModel.shelves.forEach(shelf => {\n        if (shelf === undefined) return\n        shelf.journals.forEach(journal => {\n            if (keepJournal.shelf.id !== journal.shelf.id || keepJournal.id !== journal.id) {\n                unloadEntries(journal)\n            }\n        })\n    })\n}\n\nfunction unloadEntries(journal: JournalModel | undefined) {\n    if (journal === undefined) return\n    journal.entries = []\n    journal.loaded = false\n}\n\nfunction loadEntries(journal: JournalModel | undefined) {\n    if (journal === undefined) return\n    unloadOtherJournals(journal)\n    syncerController.getRows(journal.shelf.id, journal.id, journal.title)\n        .then(payload => {\n            payload.rows.forEach((content, idx) => addEntry(journal, idx, content, false))\n            journal.loaded = true\n        })\n        .catch((error: ErrorPayload) => {\n            new FriendlyError(error.error.message, error.friendlyMsg)\n        })\n        .finally(() => {\n            m.redraw()\n        })\n}\n\n// TODO: create entry\n\nfunction addEntry(journal: JournalModel, idx: number, content: string | undefined, sync?: boolean) {\n    content = (content === undefined) ? \"\" : content\n    let entry = entryFactory.createJournalEntry(journal.shelf, journal, content)\n    entryController.save(entry, idx, content, sync)\n    journal.createEntry(idx, entry)\n    buildTags(journal)\n}\n\nfunction deleteEntry(journal: JournalModel, idx: number) {\n    journal.deleteEntry(idx)\n    buildTags(journal)\n}\n\nfunction moveEntry(journal: JournalModel, fromIdx: number, toIdx: number) {\n    if (fromIdx === toIdx) return\n    journal.moveEntry(fromIdx, toIdx)\n    buildTags(journal)\n}\n\nfunction buildTags(journal: JournalModel) {\n    let tags: Map<string, TagModel> = new Map()\n    let entries = Array.from(journal.entries.values())\n    for (let { entry } of entries.reverse()) {\n        for (let [key, tag] of entry.tags) {\n            if (tags.has(key)) {\n                tags.get(key)!.frq += tag.frq\n            } else {\n                tags.set(key, tagFactory.createTag(tag.raw, tag.flag, tag.key, tag.separator, tag.val))\n            }\n        }\n    }\n    journal.tags = tags\n    searchController.buildRefines(journal)\n}\n","export * from \"./shelfView\"\r\nexport * from \"./signinView\"\r\nexport * from \"./libraryView\"\r\nexport * from \"./journalView\"\r\nexport * from \"./testModeView\"\r\n","import m from \"mithril\"\nimport {\n    googleComponent, journalsComponent, syncStateComponent, breadcrumbComponent,\n    testModeComponent,\n} from \"../components\"\n\nexport function shelfView() {\n\n    function view() {\n        return m(\"#shelf\", [\n            m(googleComponent),\n            m(testModeComponent),\n            m(syncStateComponent),\n            m(breadcrumbComponent),\n            m(journalsComponent),\n        ])\n    }\n\n    return {\n        view: view\n    }\n\n}\n","import m from \"mithril\"\nimport { googleModel } from \"..\"\nimport { googleController } from \"../controllers\"\n\nexport function googleComponent() {\n\n    function view() {\n        return m(\"#googleApi\", [\n            preambleMessage(),\n            signInOutButton(),\n            m(\"script\", gapiScriptSettings()),\n        ])\n    }\n\n    function gapiScriptSettings() {\n        return {\n            async: true,\n            defer: true,\n            src: googleModel.src,\n            onload: () => {\n                if (!googleModel.isSignedIn) {\n                    googleController.initGapi()\n                }\n            }\n        }\n    }\n\n    function signInOutButton() {\n        return (googleModel.isSignedIn)\n            ? m(\"button\", { onclick: () => googleController.signOut(), class: \"authButton\" }, \"Sign Out\")\n            : m(\"button\", { onclick: () => googleController.signIn(), class: \"authButton\" }, \"Sign In\")\n    }\n\n    function preambleMessage() {\n        return (googleModel.isSignedIn !== undefined && !googleModel.isSignedIn)\n            ? m(\".preamble\", \"PREAMBLE MSG\") // TODO: fill out\n            : null\n    }\n\n    return { view: view }\n}\n","export const textController = {\n    escape: escape,\n    clean: clean,\n}\n\nfunction escape(unsafe: string): string {\n    return unsafe\n        .replace(/&/g, \"&amp;\")\n        .replace(/</g, \"&lt;\")\n        .replace(/>/g, \"&gt;\")\n}\n\nfunction clean(content: string): string {\n    return content.toLowerCase()\n}\n","import { textController } from \"../controllers\"\r\nimport { TagModel } from \"../models\"\r\n\r\nexport const tagFactory = {\r\n    createTag: createTag\r\n}\r\n\r\nfunction createTag(raw: string, flag: string, key: string, separator?: string | null, val?: string | null) {\r\n    separator = (separator !== undefined) ? separator : null\r\n    val = (val !== undefined) ? val : null\r\n    let clean = cleanTagString(raw)\r\n    let cleanKey = cleanTagString(key)\r\n    let cleanVal = (val !== null) ? cleanTagString(val) : null\r\n\r\n    let renderedKey = \"<span onclick=\\\"tagOnClick(event, '\"\r\n        + flag\r\n        + cleanKey\r\n        + ((separator !== null) ? separator : \"\")\r\n        + \"')\\\" class=\\\"\"\r\n        + ((separator !== null) ? \"tagKey\" : (val === null) ? \"simpleTag\" : \"roundTagVal\")\r\n        + \"\\\">\"\r\n        + flag\r\n        + key\r\n        + \"</span>\"\r\n\r\n    let renderedVal = \"\"\r\n\r\n    if (separator !== undefined && separator !== null) {\r\n        renderedVal = \"<span onclick=\\\"tagOnClick(event, '\"\r\n            + flag\r\n            + cleanKey\r\n            + separator\r\n            + ((cleanVal !== null) ? cleanVal.replace(/'/, \"\\\\'\") : \"\")\r\n            + \"')\\\" class=\\\"tagVal\\\">\"\r\n            + separator\r\n            + ((val !== null) ? val : \"\")\r\n            + \"</span>\"\r\n    }\r\n\r\n    return new TagModel(raw, flag, key, separator, val, clean, cleanKey, cleanVal, renderedKey + renderedVal)\r\n\r\n}\r\n\r\nfunction cleanTagString(str: string) {\r\n    str = textController.escape(str)\r\n    str = (str.endsWith(\"'s\")) ? str.substring(0, str.length - 2) : str\r\n    str = str.toLowerCase()\r\n    return str\r\n}\r\n","import m from \"mithril\"\n\nexport class UrlModel {\n\n    get hash(): string {\n        return window.location.hash\n    }\n    set hash(hash_: string) {\n        window.location.hash = hash_\n    }\n\n    get url(): URL {\n        return new URL(window.location.href)\n    }\n\n    public getParam(key: string): string | undefined {\n        let val = this.url.searchParams.get(key) || m.route.param(key)\n        if (val === \"\") return\n        return val\n    }\n\n    get shelfId(): string | undefined {\n        let id = m.route.param(\"shelfId\")\n        return (id === \"\") ? undefined : id\n    }\n    // TODO: set?\n\n    get journalId(): number | undefined {\n        let id = m.route.param(\"journalId\")\n        return (id === \"\") ? undefined : parseInt(id)\n    }\n    // TODO: set?\n}\n","export class TagModel {\n    public frq: number\n\n    constructor(\n        public raw: string,\n        public flag: string,\n        public key: string,\n        public separator: string | null,\n        public val: string | null,\n        public clean: string,\n        public cleanKey: string,\n        public cleanVal: string | null,\n        public rendered: string\n    ) { \n        this.frq = 1\n    }\n\n}\n","import { TagModel } from \".\"\nimport { ShelfModel, JournalModel } from \"../models\"\n\nexport class BaseEntryModel {\n    public raw: string = \"\"\n    public safe: string = \"\"\n    public clean: string = \"\"\n    public tokens: string[] = []\n    public rendered: string = \"\"\n    public tags: Map<string, TagModel> = new Map()\n    public tagMatches: { tag: TagModel, match: RegExpMatchArray }[] = []\n}\n\nexport class JournalEntryModel extends BaseEntryModel {\n    readonly id: number\n    readonly shelf: ShelfModel\n    readonly journal: JournalModel\n\n    public saved: string = \"\"\n    public savedClean: string = \"\"\n\n    constructor(shelf: ShelfModel, journal: JournalModel, entryId: number) {\n        super()\n        this.id = entryId\n        this.shelf = shelf\n        this.journal = journal\n    }\n}\n","import { JournalModel } from \".\"\n\nexport class ShelfModel {\n    readonly id: string\n    readonly title: string | undefined\n\n    public error: string | undefined\n    public journals: Map<number, JournalModel> = new Map()\n\n    constructor(id: string, title?: string, error?: string) {\n        this.id = id\n        this.error = error\n        this.title = title\n    }\n\n}\n","import { SyncerState, SyncerPayload, ErrorPayload } from \"../types\"\r\n\r\nexport class SyncerModel {\r\n    public requestsCounter: number\r\n    public requests: Map<string, Function>\r\n    public state: SyncerState\r\n\r\n    constructor() {\r\n        this.requestsCounter = 0\r\n        this.requests = new Map()\r\n        this.state = SyncerState.INITIALIZING\r\n    }\r\n\r\n    public pushSyncerTask<P extends SyncerPayload>(payload: P, worker: Worker): Promise<P> {\r\n        let id = `payload-${this.requestsCounter++}`\r\n        return new Promise((resolve, reject) => {\r\n            this.requests.set(id, ({ payload, error }: { payload: P, error: ErrorPayload }) => {\r\n                (error) ? reject(error) : resolve(payload)\r\n            })\r\n            worker.postMessage({ id, payload })\r\n        })\r\n    }\r\n\r\n}\r\n","import { MockGapi, MockGoogleUser } from \"../mocks\"\n\nexport class GoogleModel {\n    readonly src: string\n    readonly scope: string\n    readonly clientId: string\n\n    public isSignedIn: boolean | undefined\n    public gapi_: MockGapi | typeof gapi | undefined\n    public user: gapi.auth2.GoogleUser | MockGoogleUser | undefined\n\n    constructor(isSignedIn?: boolean) {\n        this.isSignedIn = isSignedIn\n        this.src = \"https://apis.google.com/js/api.js\"\n        this.scope = [\n            \"https://www.googleapis.com/auth/spreadsheets\",\n        ].join(\" \")\n        this.clientId = \"893904323330-moo1k9s19qp40kr747pftdo29ejdef0o.apps.googleusercontent.com\"\n    }\n\n    get token(): string | undefined {\n        if (!this.user) return\n        let auth = this.user.getAuthResponse()\n        return auth.access_token\n    }\n}\n","import { ShelfModel } from \"./ShelfModel\"\nimport { JournalEntryModel, TagModel } from \".\"\n\nexport class JournalModel {\n    readonly id: number\n    readonly title: string\n    readonly shelf: ShelfModel\n\n    public loaded: boolean\n    public tags: Map<string, TagModel>\n    public entries: { id: number, entry: JournalEntryModel }[]\n\n    constructor(shelf: ShelfModel, journalId: number, journalTitle: string) {\n        this.entries = []\n        this.shelf = shelf\n        this.loaded = false\n        this.id = journalId\n        this.tags = new Map()\n        this.title = journalTitle\n    }\n\n    // TODO: syncerController.* should go here to interact with the data for the journal\n    //       as if it was a real database model.\n    public createEntry(idx: number, entry: JournalEntryModel) {\n        this.entries.splice(idx, 0, { id: entry.id, entry })\n    }\n\n    public updateEntry(idx: number, entry: JournalEntryModel) {\n        this.entries[idx].entry = entry\n    }\n\n    public deleteEntry(idx: number) {\n        this.entries.splice(idx, 1)[0]\n    }\n\n    public moveEntry(fromIdx: number, toIdx: number) {\n        let entry = this.entries.splice(fromIdx, 1)[0]\n        this.entries.splice(toIdx, 0, entry)\n    }\n\n}\n","import { ShelfModel } from \".\"\n\nexport class LibraryModel {\n    public shelves: Map<string, ShelfModel | undefined>\n\n    constructor() {\n        this.shelves = new Map()\n        this.shelfIds.forEach(id => this.shelves.set(id, undefined))\n    }\n\n    set shelfIds(ids: string[]) {\n        if (ids.length === 0) {\n            localStorage.removeItem(\"spreadsheetIds\")\n        } else {\n            localStorage.setItem(\"spreadsheetIds\", ids.join(\",\"))\n        }\n    }\n    get shelfIds(): string[] {\n        let ids = localStorage.getItem(\"spreadsheetIds\")\n        return (ids === null) ? [] : ids.split(\",\")\n    }\n\n}\n","import { TestMode } from \"../types\"\n\nexport class AppStateModel {\n    public testMode: TestMode\n\n    constructor() {\n        this.testMode = TestMode.OFF\n    }\n}\n","import { FriendlyError } from \"../errors\"\n\nexport class ServiceWorkerModel {\n    constructor() {\n        if (\"serviceWorker\" in navigator) {\n            window.addEventListener(\"load\", async () => {\n                await navigator.serviceWorker.register(\"../serviceWorker.js\")\n            })\n        } else {\n            throw new FriendlyError(\"serviceWorker not supported\", \"Your browser is not supported.\")\n        }\n    }\n}\n","import m from \"mithril\"\n\nexport class FriendlyError extends Error {\n    constructor(errorMsg: string, public friendlyMsg: string) {\n        super(errorMsg)\n        console.warn(errorMsg)\n        // journal.errors.push(friendlyMsg) // TODO reassign\n        m.redraw()\n    }\n}\n","import { ShelfModel, JournalModel } from \"../models\"\n\nexport const shelfFactory = {\n    createShelf: createShelf,\n}\n\nfunction createShelf(spreadsheetId: string, spreadsheet?: gapi.client.sheets.Spreadsheet, error?: string): ShelfModel {\n    if (\n        spreadsheet !== undefined &&\n        spreadsheet.spreadsheetId !== undefined &&\n        spreadsheet.properties !== undefined &&\n        spreadsheet.properties.title !== undefined &&\n        spreadsheet.sheets !== undefined\n    ) {\n        let shelf = new ShelfModel(spreadsheet.spreadsheetId, spreadsheet.properties.title)\n        getJournals(shelf, spreadsheet.sheets).forEach(journal => shelf.journals.set(journal.id, journal))\n        return shelf\n    }\n    return new ShelfModel(spreadsheetId, undefined, error)\n}\n\nfunction getJournals(shelf: ShelfModel, sheets: gapi.client.sheets.Sheet[]): JournalModel[] {\n    let journals: JournalModel[] = []\n    sheets.forEach(sheet => {\n        if (\n            sheet.properties !== undefined &&\n            sheet.properties.title !== undefined &&\n            sheet.properties.sheetId !== undefined\n        ) {\n            let journal = new JournalModel(\n                shelf, sheet.properties.sheetId, sheet.properties.title\n            )\n            if (journal === undefined) return\n            journals.push(journal)\n        }\n    })\n    return journals\n}\n","import { entryController } from \"../controllers\"\nimport { JournalEntryModel, ShelfModel, JournalModel, BaseEntryModel } from \"../models\"\n\nlet entryCounter = -1\n\nexport const entryFactory = {\n    createBaseEntry: createBaseEntry,\n    createJournalEntry: createJournalEntry\n}\n\nfunction createBaseEntry(content?: string) {\n    let entry = new BaseEntryModel()\n    entryController.update(entry, content || \"\")\n    return entry\n}\n\nfunction createJournalEntry(shelf: ShelfModel, journal: JournalModel, content: string) {\n    let entry = new JournalEntryModel(shelf, journal, entryCounter += 1)\n    entryController.update(entry, content)\n    return entry\n}\n","export const caretController = {\n    getCaretPosition: getCaretPosition,\n    setCaretPosition: setCaretPosition,\n}\n\nfunction node_walk(node: any, func: any): void {\n    var result = func(node)\n    for (node = node.firstChild; result !== false && node; node = node.nextSibling)\n        result = node_walk(node, func)\n    return\n}\n\nfunction getCaretPosition(elem: any) {\n    var sel: any = window.getSelection()\n    var cum_length = [0, 0]\n\n    if (sel.anchorNode == elem) {\n        cum_length = [sel.anchorNode.innerText.length, sel.extentNode.innerText.length]\n    } else {\n        var nodes_to_find = [sel.anchorNode, sel.extentNode]\n        if (!elem.contains(sel.anchorNode) || !elem.contains(sel.extentNode)) {\n            return undefined\n        } else {\n            var found = [0, 0]\n            var i\n            node_walk(elem, function (node: any): void {\n                for (i = 0; i < 2; i++) {\n                    if (node == nodes_to_find[i]) {\n                        found[i] = 1\n                        if (found[i == 0 ? 1 : 0]) {\n                            return\n                        }\n                    }\n                }\n                if (node.textContent && !node.firstChild) {\n                    for (i = 0; i < 2; i++) {\n                        if (!found[i]) {\n                            cum_length[i] += node.textContent.length\n                        }\n                    }\n                }\n            })\n            cum_length[0] += sel.anchorOffset\n            cum_length[1] += sel.extentOffset\n        }\n    }\n    if (cum_length[0] <= cum_length[1]) {\n        return cum_length\n    }\n    return [cum_length[1], cum_length[0]]\n}\n\nfunction setCaretPosition(el: any, pos: any): any {\n    if (el !== null && pos !== null) {\n        for (var node of el.childNodes) {\n            if (node.nodeType == 3) {\n                if (node.length >= pos) {\n                    let range = document.createRange()\n                    let sel: any = window.getSelection()\n                    range.setStart(node, pos)\n                    range.collapse(true)\n                    sel.removeAllRanges()\n                    sel.addRange(range)\n                    return -1\n                } else {\n                    pos -= node.length\n                }\n            } else {\n                pos = setCaretPosition(node, pos)\n                if (pos == -1) {\n                    return -1\n                }\n            }\n        }\n        return pos\n    }\n}\n","import { searchModel } from \"..\"\nimport { SearchType } from \"../types\"\nimport { entryFactory } from \"../factories\"\nimport { entryController } from \"./entryController\"\nimport { TagModel, JournalModel, JournalEntryModel } from \"../models\"\n\nexport const searchController = {\n    reset: reset,\n    buildRefines: buildRefines,\n    filteredEntries: filteredEntries,\n    updateSearchbar: updateSearchbar,\n}\n\nfunction updateSearchbar(content: string) {\n    entryController.update(searchModel.barQuery, content)\n}\n\nfunction reset() {\n    searchModel.searchType = SearchType.NONE\n    searchModel.barQuery = entryFactory.createBaseEntry()\n    searchModel.refinesQuery = { keys: new Set(), vals: new Map(), simpleKeys: new Map() }\n}\n\nfunction buildRefines(journal: JournalModel) {\n    let simpleRefines: Map<string, TagModel> = new Map()\n    let complexRefines: Map<string, TagModel[]> = new Map()\n\n    for (let tag of journal.tags.values()) {\n        if (tag.val === null) {\n            let key = `${tag.flag}${tag.cleanKey}`\n            if (!simpleRefines.has(key)) {\n                simpleRefines.set(key, tag)\n            }\n        } else {\n            let key = `${tag.flag}${tag.cleanKey}${tag.separator}`\n            if (!complexRefines.has(key)) { complexRefines.set(key, []) }\n            complexRefines.get(key)!.push(tag)\n        }\n    }\n\n    searchModel.simpleRefines = new Map([...simpleRefines.entries()])\n    searchModel.complexRefines = new Map([...complexRefines.entries()].sort())\n\n    cleanRefines()\n}\n\nfunction cleanRefines() {\n    // Clean stale simple tag key (refine val) selections\n    for (let [key,] of searchModel.refinesQuery.simpleKeys) {\n        if (!searchModel.simpleRefines.has(key)) {\n            searchModel.refinesQuery.simpleKeys.delete(key)\n        }\n    }\n\n    // Clean stale complex tag key selections\n    for (let key of searchModel.refinesQuery.keys) {\n        if (!searchModel.complexRefines.has(key)) {\n            searchModel.refinesQuery.keys.delete(key)\n        }\n    }\n\n    // Clean stale complex tag val\n    for (let [key,] of searchModel.refinesQuery.vals) {\n        if (!Array.from(searchModel.complexRefines.values()).some(tags => tags.some(tag => tag.clean === key))) {\n            searchModel.refinesQuery.vals.delete(key)\n        }\n    }\n}\n\nfunction filteredEntries(entries: { id: number, entry: JournalEntryModel }[]): { idx: number, entry: JournalEntryModel }[] {\n    let filteredEntries: { idx: number, entry: JournalEntryModel }[] = []\n    if (searchModel.query.tokens.length === 0) {\n        searchModel.searchType = SearchType.NONE\n        filteredEntries = entries.map(({ entry }, idx) => { return { idx, entry } })\n    } else {\n        searchModel.searchType = SearchType.AND\n        filteredEntries = search(entries)\n        if (filteredEntries.length === 0) {\n            searchModel.searchType = SearchType.OR\n            filteredEntries = search(entries)\n        }\n    }\n    return filteredEntries\n}\n\nfunction search(entries: { id: number, entry: JournalEntryModel }[]): { idx: number, entry: JournalEntryModel }[] {\n    let query = searchModel.query\n    let sourceEntries = entries\n    let filteredEntries: { idx: number, entry: JournalEntryModel }[] = []\n    for (let [idx, { entry }] of sourceEntries.entries()) {\n        switch (searchModel.searchType) {\n            case SearchType.AND:\n                if (query.tokens.every(token => match(token, entry))) {\n                    filteredEntries.push({ idx, entry })\n                }\n                break\n            case SearchType.OR:\n                if (query.tokens.some(token => match(token, entry))) {\n                    filteredEntries.push({ idx, entry })\n                }\n                break\n        }\n    }\n    return filteredEntries\n}\n\nfunction match(token: string, entry: JournalEntryModel) {\n\n    if (token.startsWith(\"-@\") && !token.endsWith(\":\")) {\n        return entry.tags.get(token.substring(1)) === undefined\n    } else if (token.startsWith(\"-\")) {\n        return !entry.savedClean.includes(token.substring(1))\n    } else if (token.startsWith(\"@\") && !token.endsWith(\":\")) {\n        return entry.tags.get(token) !== undefined\n    } else {\n        return entry.savedClean.includes(token)\n    }\n}\n","import m from \"mithril\"\r\nimport { MockGapi } from \"../mocks\"\r\nimport { TestMode } from \"../types\"\r\nimport { googleModel, appStateModel } from \"..\"\r\nimport { syncerController, libraryController } from \"../controllers\"\r\nimport { urlController } from \"./urlController\"\r\n\r\nexport const googleController = {\r\n    signIn: signIn,\r\n    signOut: signOut,\r\n    initGapi: initGapi,\r\n}\r\n\r\nfunction signOut() {\r\n    googleModel.gapi_!.auth2.getAuthInstance().signOut()\r\n}\r\n\r\nfunction signIn() {\r\n    googleModel.gapi_!.auth2.getAuthInstance().signIn()\r\n}\r\n\r\nfunction initGapi() {\r\n    let gapi_ = (appStateModel.testMode === TestMode.OFF) ? gapi : new MockGapi()\r\n    googleModel.gapi_ = gapi_\r\n    googleModel.gapi_.load('auth2', () => {\r\n        googleModel.gapi_!.auth2.init({\r\n            scope: googleModel.scope, client_id: googleModel.clientId\r\n        }).then(() => {\r\n            googleModel.gapi_!.auth2.getAuthInstance().isSignedIn.listen(isSignedIn)\r\n            isSignedIn((googleModel.gapi_!.auth2.getAuthInstance().isSignedIn.get()))\r\n        })\r\n    })\r\n}\r\n\r\nasync function isSignedIn(signedIn: boolean) {\r\n    googleModel.isSignedIn = signedIn\r\n    if (googleModel.isSignedIn) {\r\n        googleModel.user = googleModel.gapi_!.auth2.getAuthInstance().currentUser.get()\r\n        syncerController.updateAuth(googleModel.token)\r\n        libraryController.loadShelves()\r\n    } else {\r\n        libraryController.removeShelves()\r\n        urlController.redirect(\"/\")\r\n    }\r\n    m.redraw()\r\n}\r\n","export * from \"./Gapi\"\n","export class MockGapi {\n    public auth2 = new MockAuth2()\n    public load(_api: string, _callback: () => void) {\n        _callback()\n    }\n}\n\nclass MockAuth2 {\n    public getAuthInstance() {\n        return new MockGoogleAuth()\n    }\n    public async init(_params: any) { }\n}\n\nclass MockCurrentUser {\n    public get() { return new MockGoogleUser() }\n}\n\nexport class MockGoogleUser {\n    public getAuthResponse() {\n        return {\n            expires_in: 9999,\n            access_token: \"faketoken\"\n        }\n    }\n    public async reloadAuthResponse() {\n        return {\n            expires_in: 9999,\n            access_token: \"faketoken\"\n        }\n    }\n}\n\nclass MockGoogleAuth {\n    public isSignedIn = new MockIsSignedIn()\n    public signOut() { }\n    public signIn() { }\n    public currentUser = new MockCurrentUser()\n}\n\nclass MockIsSignedIn {\n    public listen = (_callback: any) => { }\n    public get = () => { return true }\n}\n","import m from \"mithril\"\nimport { libraryModel } from \"..\"\nimport { ErrorPayload } from \"../types\"\nimport { FriendlyError } from \"../errors\"\nimport { shelfFactory } from \"../factories\"\nimport { syncerController } from \"../controllers\"\nimport { urlController } from \"./urlController\"\nimport { journalController } from \"./journalController\"\n\nconst spreadsheetIdPattern = /\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/g\n\nexport const libraryController = {\n    addShelves: addShelves,\n    loadShelves: loadShelves,\n    removeShelves: removeShelves,\n    getSpreadsheetIdsFromUrls: getSpreadsheetIdsFromUrls,\n}\n\nfunction addShelves(urls: string) {\n    let ids = getSpreadsheetIdsFromUrls(urls)\n    ids = ids.filter(id => !libraryModel.shelves.has(id))\n    ids.forEach(id => libraryModel.shelves.set(id, undefined))\n    libraryModel.shelfIds = Array.from(libraryModel.shelves.keys())\n    loadShelves(false, ids)\n}\n\nfunction removeShelves(ids?: string[]) {\n    if (ids === undefined) ids = Array.from(libraryModel.shelves.keys())\n    ids = ids.filter(id => libraryModel.shelves.has(id))\n    ids.forEach(id => libraryModel.shelves.delete(id))\n    libraryModel.shelfIds = Array.from(libraryModel.shelves.keys())\n}\n\nfunction loadShelves(reloadLoaded?: boolean, ids?: string[]) {\n    if (ids === undefined) ids = Array.from(libraryModel.shelves.keys())\n    if (reloadLoaded) {\n        ids.forEach(id => libraryModel.shelves.set(id, undefined))\n        m.redraw()\n    }\n    ids.filter(id => !libraryModel.shelves.get(id))\n        .forEach(id => syncerController.getSpreadsheet(id)\n        .then(payload => {\n            let shelf = shelfFactory.createShelf(id, payload.spreadsheet)\n            libraryModel.shelves.set(shelf.id, shelf)\n            let journal = urlController.getActiveJournal()\n            if (journal && journal.shelf === shelf) {\n                journalController.loadEntries(journal)\n            }\n        })\n        .catch((error: ErrorPayload) => {\n            new FriendlyError(error.error.message, error.friendlyMsg)\n            let shelf = shelfFactory.createShelf(id, undefined, error.friendlyMsg)\n            libraryModel.shelves.set(id, shelf)\n        })\n        .finally(() => {\n            m.redraw()\n        })\n    )\n}\n\nfunction getSpreadsheetIdsFromUrls(urls: string | undefined): string[] {\n    let ids: string[] = []\n    if (urls) {\n        Array.from(urls.matchAll(spreadsheetIdPattern)).forEach(m => ids.push(m[1]))\n    }\n    return ids\n}\n","import { appStateModel } from \"..\"\nimport { syncerController } from \"./syncerController\"\nimport { TestMode, instanceOfTestMode } from \"../types\"\n\nexport const appStateController = {\n    updateTestMode: updateTestMode,\n}\n\nfunction updateTestMode(mode: TestMode | string | undefined) {\n    if (mode !== undefined && instanceOfTestMode(mode) && mode !== appStateModel.testMode) {\n        appStateModel.testMode = mode\n        syncerController.updateTestMode(mode)\n    }\n}\n","import m from \"mithril\"\nimport { Caret } from \"../types\"\nimport { entryFactory } from \"../factories\"\nimport { BaseEntryModel, JournalModel } from \"../models\"\nimport { urlController, journalController, caretController, entryController } from \"../controllers\"\n\nexport function composeComponent() {\n    var caret: Caret = { el: null, pos: null }\n\n    const composePrefixEntry = entryFactory.createBaseEntry()\n    const composeContentEntry = entryFactory.createBaseEntry()\n    const composeSuffixEntry = entryFactory.createBaseEntry()\n\n    const prefixSettings = { \"placeholder\": \"Static Entry Prefix\" }\n    const entrySettings = { \"placeholder\": \"Entry Content\" }\n    const suffixSettings = { \"placeholder\": \"Static Entry Suffix\" }\n\n    function view() {\n        const journal = urlController.getActiveJournal()\n        if (journal === undefined || journal.loaded === false) return\n        return m(\"#compose\", [\n            m(\n                \"#prefix\",\n                composeNodeSettings(composePrefixEntry, journal, prefixSettings),\n                m.trust(composePrefixEntry.rendered)\n            ),\n            m(\n                \"#content\",\n                composeNodeSettings(composeContentEntry, journal, entrySettings),\n                m.trust(composeContentEntry.rendered)\n            ),\n            m(\n                \"#suffix\",\n                composeNodeSettings(composeSuffixEntry, journal, suffixSettings),\n                m.trust(composeSuffixEntry.rendered)\n            ),\n        ])\n    }\n\n    function getComposedContent() {\n        let els = [\n            document.getElementById(\"prefix\"),\n            document.getElementById(\"content\"),\n            document.getElementById(\"suffix\"),\n        ]\n        return els.map(el => el!.innerText).join(\"\")\n    }\n\n    function composeNodeSettings(entry: BaseEntryModel, journal: JournalModel, extraSettings: object) {\n        let baseSettings = {\n            contenteditable: \"true\",\n            class: \"entry breakwrap column\",\n            onkeydown: async (event: any) => await composeKeydown(event, journal),\n            oninput: (event: any) => composeInput(event, entry),\n            onupdate: () => composeUpdate(),\n        }\n        return Object.assign(baseSettings, extraSettings)\n    }\n\n    async function composeKeydown(event: any, journal: JournalModel) {\n        if (event.keyCode == 13 && !event.shiftKey) {\n            event.preventDefault()\n            let content = getComposedContent()\n            entryController.update(composeContentEntry, \"\")\n            let idx = journal.entries.length\n            journalController.addEntry(journal, idx, content, true)\n        }\n    }\n\n    function composeInput(event: any, entry: BaseEntryModel) {\n        let pos = caretController.getCaretPosition(event.target)\n        caret.pos = (pos) ? pos[1] : null\n        caret.el = event.target\n        entryController.update(entry, event.target.innerText)\n    }\n\n    function composeUpdate() {\n        caretController.setCaretPosition(caret.el, caret.pos)\n        caret.pos = null\n        caret.el = null\n    }\n\n    return { view: view }\n}\n","import m from \"mithril\"\nimport { Caret } from \"../types\"\nimport { JournalModel, JournalEntryModel } from \"../models\"\nimport {\n    caretController, urlController, entryController, journalController, searchController\n} from \"../controllers\"\n\nexport function entriesComponent() {\n    const caret: Caret = { pos: null, el: null }\n\n    function view() {\n        let shelf = urlController.getActiveShelf()\n        const journal = urlController.getActiveJournal()\n        if (!shelf || !journal) return null\n\n        return m(\"#entries\", [\n            m(\".tempguidancePre\", \"Entries\"),\n            entriesList(journal),\n        ])\n    }\n\n    function entriesList(journal: JournalModel) {\n        return searchController.filteredEntries(journal.entries)\n            .map(({ idx, entry }) => entryVnode(entry, idx))\n    }\n\n    function entryVnode(entry: JournalEntryModel, entryIdx: number): m.Vnode {\n        return m(\".entryWrap\", { id: `entry-${entry.id}` }, [\n            entryContent(entry, entryIdx),\n            deleteEntryButton(entry, entryIdx),\n        ])\n    }\n\n    function deleteEntryButton(entry: JournalEntryModel, entryIdx: number) {\n        return m(\"button\", {\n            class: \"del\",\n            onclick: async () => journalController.deleteEntry(entry.journal, entryIdx)\n        }, \"del\")\n    }\n\n    function entryContent(entry: JournalEntryModel, entryIdx: number) {\n        return m(\"div\", entryContentSettings(entry, entryIdx), m.trust(entry.rendered))\n    }\n\n    function onEntryKeydown(event: any) {\n        event.redraw = false\n        if (event.keyCode == 13 && !event.shiftKey) {\n            event.preventDefault()\n            event.target.blur()\n        }\n    }\n\n    function onEntryInput(event: any, entry: JournalEntryModel) {\n        let pos = caretController.getCaretPosition(event.target)\n        caret.pos = (pos) ? pos[1] : null\n        caret.el = event.target\n        entryController.update(entry, event.target.innerText)\n    }\n\n    function onEntryUpdate(event: any) {\n        event.redraw = false\n        caretController.setCaretPosition(caret.el, caret.pos)\n        caret.pos = null\n        caret.el = null\n    }\n\n    async function onEntryBlur(event: any, entry: JournalEntryModel, entryIdx: number) {\n        event.redraw = false\n        entryController.save(entry, entryIdx, event.target.innerText, true)\n        journalController.buildTags(entry.journal)\n    }\n\n    function entryContentSettings(entry: JournalEntryModel, entryIdx: number) {\n        return {\n            id: `entry-${entry.id}-content`,\n            contenteditable: \"true\",\n            class: \"entry breakwrap column\",\n            onkeydown: (event: any) => onEntryKeydown(event),\n            oninput: (event: any) => onEntryInput(event, entry),\n            onupdate: (event: any) => onEntryUpdate(event),\n            onblur: (event: any) => onEntryBlur(event, entry, entryIdx),\n        }\n    }\n\n    return { view: view }\n}\n","import m from \"mithril\"\nimport { libraryModel } from \"..\"\nimport { ShelfModel } from \"../models\"\nimport { libraryController } from \"../controllers\"\n\nexport function shelvesComponent() {\n\n    function view() {\n        let shelves = Array.from(libraryModel.shelves.entries())\n        return m(\"#shelvesList\", shelves.map(([id, shelf]) => shelfNode(id, shelf)))\n    }\n\n    function delShelfButton(id: string) {\n        return m(\"button\", {\n            class: \"del\",\n            onclick: () => libraryController.removeShelves([id])\n        }, \"del\")\n    }\n\n    function retryShelfLoadButton(id: string) {\n        return m(\"button\", {\n            onclick: () => libraryController.loadShelves(true, [id])\n        }, \"retry\")\n    }\n\n    function shelfNode(id: string, shelf: ShelfModel | undefined) {\n        if (shelf === undefined) {\n            return m(\"li\", [\n                delShelfButton(id),\n                m(\"span\", id)\n            ])\n        } else if (shelf.error !== undefined) {\n            return m(\"li\", [\n                delShelfButton(id),\n                m(\"span\", `${id} ${shelf.error}`),\n                retryShelfLoadButton(id)\n            ])\n        } else {\n            return m(\"li\", [\n                delShelfButton(id),\n                m(\"a\", { href: `#/library/${id}` }, shelf.title)\n            ])\n        }\n    }\n\n    return {\n        view: view,\n    }\n\n}\n","import m from \"mithril\"\nimport { searchModel } from \"..\"\nimport { urlController } from \"../controllers\"\nimport { TagModel } from \"../models\"\n\nexport function refinesComponent() {\n    const simpleTagsHeader = \"Simple Tags\"\n    const expanded: Set<string> = new Set()\n\n    function view() {\n        const journal = urlController.getActiveJournal()\n        if (journal === undefined || journal.loaded === false) return\n        return m(\"#tagsWrap\", m(\"#tags\", [\n            m(\".tempguidancePre\", \"Tags\"),\n            simpleRefinesVnodes(),\n            complexRefinesVnodes(),\n        ]))\n    }\n\n    function simpleRefinesVnodes() {\n        if (searchModel.simpleRefines.size === 0) return\n        return m(\".tagRefineWrap\", [\n            refineKeyVnode(simpleTagsHeader, searchModel.simpleRefines.size),\n            Array.from(searchModel.simpleRefines, ([key, tag]) => [\n                refineValVnode(key, tag)\n            ])\n        ])\n    }\n\n    function complexRefinesVnodes(): m.Vnode[] {\n        return Array.from(searchModel.complexRefines, ([key, tags]) => m(\".tagRefineWrap\", [\n            refineKeyVnode(key, tags.length),\n            tags.map(tag => [refineValVnode(key, tag)])\n        ]))\n    }\n\n    function refineKeyVnode(key: string, count: number) {\n        return m(\"span\", tagRefineKeySettings(key), [\n            (key === simpleTagsHeader)\n                ? []\n                : m(\"input\", { type: \"checkbox\", checked: searchModel.refinesQuery.keys.has(key) }),\n            (expanded.has(key)) ? m(\"span\", \" \") : m(\"span\", \" \"),\n            m(\"span\", key),\n            m(\"span\", ` (${count})`),\n        ])\n    }\n\n    function refineValVnode(key: string, tag: TagModel) {\n        return m(\"div\", { class: `tagRefineValWrap` }, [\n            m(\"span\", tagRefineValSettings(key, tag), [\n                m(\"input\", {\n                    type: \"checkbox\", checked: (tag.val === null)\n                        ? searchModel.refinesQuery.simpleKeys.has(tag.clean)\n                        : searchModel.refinesQuery.vals.has(tag.clean)\n                }),\n                (tag.val !== null)\n                    ? m(\"span\", `${tag.cleanVal}`)\n                    : m(\"span\", `${tag.flag}${tag.cleanKey}`),\n                m(\"span\", ` (${tag.frq})`),\n            ]),\n        ])\n    }\n\n    function tagRefineKeySettings(key: string) {\n        return {\n            class: \"roundTagKey\",\n            onclick: (event: any) => refineTagKeyOnClick(event, key),\n        }\n    }\n\n    function tagRefineValSettings(key: string, tag: TagModel) {\n        let tagClass = (tag.val === null) ? \"simpleTag\" : \"roundTagVal\"\n        let hideClass = \"hide\"\n        if (\n            (tag.val === null && expanded.has(simpleTagsHeader)) ||\n            expanded.has(key) ||\n            searchModel.refinesQuery.vals.has(tag.clean)\n        ) {\n            hideClass = \"\"\n        }\n        return {\n            class: `${tagClass} ${hideClass}`,\n            onclick: () => refineTagValOnClick(tag),\n        }\n    }\n\n    function refineTagKeyOnClick(event: any, key: string) {\n        if (!event.metaKey && !event.ctrlKey) {\n            expanded.has(key) ? expanded.delete(key) : expanded.add(key)\n        } else {\n            if (key === simpleTagsHeader) { return }\n            searchModel.refinesQuery.keys.has(key)\n                ? searchModel.refinesQuery.keys.delete(key)\n                : searchModel.refinesQuery.keys.add(key)\n        }\n    }\n\n    function refineTagValOnClick(tag: TagModel) {\n        if (tag.val === null) {\n            searchModel.refinesQuery.simpleKeys.has(tag.clean)\n                ? searchModel.refinesQuery.simpleKeys.delete(tag.clean)\n                : searchModel.refinesQuery.simpleKeys.set(tag.clean, tag)\n        } else {\n            searchModel.refinesQuery.vals.has(tag.clean)\n                ? searchModel.refinesQuery.vals.delete(tag.clean)\n                : searchModel.refinesQuery.vals.set(tag.clean, tag)\n        }\n    }\n\n    return { view: view }\n}\n","import m from \"mithril\"\nimport { appStateModel } from \"..\"\nimport { TestMode } from \"../types\"\nimport { urlController } from \"../controllers\"\n\nexport function testModeComponent() {\n\n    function view() {\n        if (appStateModel.testMode !== TestMode.OFF) {\n            return m(\"#testMode\", [\n                m(\"span\", `${appStateModel.testMode} active `),\n                stopDemoButton()\n            ])\n        }\n        return\n    }\n\n    function stopDemoButton() {\n        if (appStateModel.testMode === TestMode.DEMO) {\n            return m(\"button\", { onclick: () => {\n                urlController.redirect(`/library/${TestMode.OFF}`)\n            }, class: \"stopDemo\" }, \"Start Now\")\n        }\n        return\n    }\n\n    return { view: view }\n}\n","import m from \"mithril\"\nimport { urlController } from \"../controllers\"\n\nexport function journalsComponent() {\n\n    function view() {\n        return m(\"#journals\", journalList())\n    }\n\n    function journalList() {\n        let shelf = urlController.getActiveShelf()\n        if (shelf === undefined) {\n            urlController.redirect(\"/library\")\n            return\n        }\n        return Array.from(shelf.journals.values()).map(journal => {\n            let link = `#/library/${journal.shelf.id}/${journal.id}`\n            return m(\"li\", m(\"a\", { href: link }, journal.title))\n        })\n    }\n\n    return {\n        view: view,\n    }\n\n}\n","import m from \"mithril\"\nimport { SyncerState } from \"../types\"\nimport { syncerController } from \"../controllers\"\nimport { syncerModel, googleModel, libraryModel } from \"..\"\n\nexport function syncStateComponent() {\n\n    function view() {\n        if (!googleModel.isSignedIn || libraryModel.shelves.size === 0) return\n        return m(\"#status\", m(\"span\", syncState()))\n    }\n\n    function syncState() {\n        return m(\"span\", [\n            syncStateIcon(),\n            syncStateText(),\n            unpauseSync()\n        ])\n    }\n\n    function syncStateText() {\n        let txt = \"\"\n        let class_ = `syncState ${stateColorClass()}`\n\n        switch (syncerModel.state) {\n            case SyncerState.DOWNLOADING:\n                txt = \"Downloading journal data from drive...\"\n                break\n            case SyncerState.PAUSED:\n                txt = \"Warning! - Syncing is paused.\"\n                break\n            case SyncerState.SYNCED:\n                txt = \"Cloud synced.\"\n                break\n            case SyncerState.UPLOADING:\n                txt = \"Uploading changes to drive...\"\n                break\n            case SyncerState.INITIALIZING:\n                txt = \"Initializing...\"\n        }\n        return m(\"span\", { id: \"syncStateText\", class: class_ }, txt)\n    }\n\n    function syncStateIcon() {\n        let class_ = `material-icons material-icons-outlined syncState ${stateColorClass()}`\n        return m(\"i\", { id: \"syncStateIcon\", class: class_ }, syncerModel.state)\n    }\n\n    function unpauseSync() {\n        if (syncerModel.state === SyncerState.PAUSED) {\n            return m(\"button\", {\n                id: \"unpauseSync\",\n                class: \"syncState\",\n                onclick: () => syncerController.unpause()\n            }, \"Unpause Syncing\")\n        }\n        return\n    }\n\n    function stateColorClass() {\n        switch (syncerModel.state) {\n            case SyncerState.PAUSED:\n                return \"error\"\n            case SyncerState.SYNCED:\n                return \"okay\"\n            default:\n                return \"warn\"\n        }\n    }\n\n    return { view: view }\n}\n","import m from \"mithril\"\nimport { searchModel } from \"..\"\nimport { Caret } from \"../types\"\nimport { caretController, textController, searchController, urlController } from \"../controllers\"\n\n\nexport function searchbarComponent() {\n    const caret: Caret = { pos: null, el: null }\n\n    function view() {\n        const journal = urlController.getActiveJournal()\n        if (journal === undefined || journal.loaded === false) return\n        return m(\"#search\", [\n            m(\"#searchQuery\", searchNodeSettings(), m.trust(searchModel.barQuery.rendered)),\n            m(\"button\", clearSearchNodeSettings(), \"x\")\n        ])\n    }\n\n    function searchNodeSettings() {\n        return {\n            placeholder: \"Search for text or tags\",\n            contenteditable: \"true\",\n            class: `entry breakwrap`,\n            oninput: (event: any) => onSearchInput(event),\n            onupdate: () => onSearchUpdate(),\n            onkeydown: (event: any) => onSearchKeydown(event)\n        }\n    }\n\n    function onSearchInput(event: any) {\n        let pos = caretController.getCaretPosition(event.target)\n        caret.pos = (pos) ? pos[1] : null\n        caret.el = event.target\n        searchController.updateSearchbar(textController.escape(event.target.innerText))\n    }\n\n    function onSearchUpdate() {\n        caretController.setCaretPosition(caret.el, caret.pos)\n        caret.pos = null\n        caret.el = null\n    }\n\n    function onSearchKeydown(event: any) {\n        if (event.keyCode == 13 && !event.shiftKey) {\n            event.preventDefault()\n            event.target.blur()\n        }\n    }\n\n    function clearSearchNodeSettings() {\n        return {\n            id: \"clearSearch\",\n            class: \"del\",\n            onclick: () => searchController.updateSearchbar(\"\")\n        }\n    }\n\n    return { view: view }\n}\n","import m from \"mithril\"\r\nimport { libraryController } from \"../controllers\"\r\nimport { libraryModel } from \"..\"\r\n\r\nexport function addShelvesComponent() {\r\n\r\n    let newShelfUrls = \"\"\r\n    let addingShelves = false\r\n\r\n    function view() {\r\n        return m(\"#addShelves\", [\r\n            addShelvesMessage(),\r\n            addShelvesButton(),\r\n            addShelvesTextbox(),\r\n        ])\r\n    }\r\n\r\n    function addShelvesMessage() {\r\n        if (libraryModel.shelves.size !== 0) return\r\n        return m(\"span\", \"Add Google Spreadsheet URLs here to get started. \")\r\n    }\r\n\r\n    function addShelvesButton() {\r\n        return m(\"button\", {\r\n            id: \"addShelvesButton\",\r\n            onclick: async () => {\r\n                if (addingShelves) libraryController.addShelves(newShelfUrls)\r\n                newShelfUrls = \"\"\r\n                addingShelves = !addingShelves\r\n            }\r\n        }, (addingShelves) ? \"  \" : \"+/-\")\r\n    }\r\n\r\n    function addShelvesTextbox() {\r\n        if (!addingShelves) return null\r\n        return m(\"textarea\", {\r\n            id: \"addShelvesText\",\r\n            placeholder: \"Enter list of Google Sheets Spreadsheet URLs here\",\r\n            oninput: (event: any) => newShelfUrls = event.target.value\r\n        })\r\n    }\r\n\r\n    return {\r\n        view: view,\r\n    }\r\n\r\n}\r\n","import m from \"mithril\"\nimport { googleModel } from \"..\"\nimport { urlController } from \"../controllers\"\n\nexport function breadcrumbComponent() {\n\n    function view() {\n        if (!googleModel.isSignedIn) return\n        return m(\"#breadcrumb\", urlController.getBreadcrumbTrail())\n    }\n\n    return {\n        view: view,\n    }\n\n}\n","import m from \"mithril\"\r\nimport { googleModel } from \"..\"\r\nimport { urlController } from \"../controllers\"\r\nimport { googleComponent } from \"../components\"\r\n\r\nexport function signinView() {\r\n\r\n    function view() {\r\n        return m(\"#auth\", [\r\n            m(googleComponent),\r\n        ])\r\n    }\r\n\r\n    function onupdate() {\r\n        if (googleModel.isSignedIn) {\r\n            urlController.redirect(\"/library\")\r\n        }\r\n    }\r\n\r\n    return {\r\n        view: view,\r\n        onupdate: onupdate,\r\n    }\r\n\r\n}\r\n","import m from \"mithril\"\nimport { \n    googleComponent, shelvesComponent, syncStateComponent, addShelvesComponent,\n    testModeComponent,\n} from \"../components\"\n\nexport function libraryView() {\n\n    function view() {\n        return m(\"#library\", [\n            m(googleComponent),\n            m(testModeComponent),\n            m(syncStateComponent),\n            m(addShelvesComponent),\n            m(shelvesComponent),\n        ])\n    }\n\n    return {\n        view: view\n    }\n\n}\n","import m from \"mithril\"\nimport { urlController, journalController } from \"../controllers\"\nimport {\n    googleComponent, breadcrumbComponent, entriesComponent, syncStateComponent,\n    searchbarComponent, refinesComponent, composeComponent, testModeComponent,\n} from \"../components\"\n\nexport function journalView() {\n\n    function oninit() {\n        const journal = urlController.getActiveJournal()\n        if (journal === undefined || journal.loaded) return\n        journalController.loadEntries(journal)\n    }\n\n    function view() {\n        return m(\"#shelf\", [\n            m(googleComponent),\n            m(testModeComponent),\n            m(syncStateComponent),\n            m(breadcrumbComponent),\n            m(searchbarComponent),\n            m(refinesComponent),\n            m(\"#entriesWrap\", [\n                m(entriesComponent),\n                m(composeComponent),\n            ])\n        ])\n    }\n\n    return {\n        view: view,\n        oninit: oninit,\n    }\n\n}\n","\nimport { urlModel } from \"..\"\nimport { urlController, appStateController } from \"../controllers\"\nimport { TestMode } from \"../types\"\n\nexport function testModeView() {\n    // TODO: WORK OUT HOW TO MANAGE TEST MODE\n    function view() {\n        if (urlModel.hash.startsWith(\"#/demo\")) {\n            appStateController.updateTestMode(TestMode.DEMO)\n            urlController.redirect(\"/library\")\n        }\n\n        if (urlModel.hash.startsWith(\"#/setTestMode\")) {\n            appStateController.updateTestMode(urlModel.getParam(\"testMode\"))\n            urlController.redirect(\"/\")\n        }\n    }\n\n    return {\n        view: view\n    }\n\n}\n"],"sourceRoot":""}